generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                 @id @default(cuid())
  email                  String                 @unique
  name                   String
  role                   Role                   @default(DOCTOR)
  speciality             String?
  crmNumber              String?                @unique
  licenseNumber          String? // Generic for CRM, COREN, CRP, etc.
  licenseType            String? // 'CRM', 'COREN', 'CRP', 'OAB', etc.
  licenseState           String? // 'SP', 'RJ', etc.
  phone                  String?
  patientId              String?                @unique
  patient                Patient?               @relation("UserPatient", fields: [patientId], references: [id])
  isActive               Boolean                @default(true)
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  password               String?
  aiInteractions         AIInteraction[]
  evaluationsAsEvaluator CapabilityEvaluation[] @relation("EvaluatorUser")
  evaluationsAsSubject   CapabilityEvaluation[]
  consultations          Consultation[]
  doctorSchedules        DoctorSchedule[]
  examRequests           ExamRequest[]
  medicalRecords         MedicalRecord[]
  notifications          Notification[]
  patients               Patient[]
  prescriptions          Prescription[]
  referrals              Referral[]
  scheduleExceptions     ScheduleException[]
  jobRoles               UserJobRole[]
  person                 Person?
  termAcceptances        TermAcceptance[]
  protocols              Protocol[] // Protocolos criados pelo médico
  stratumAssessments     StratumAssessment[]    @relation("UserStratumAssessments")
  strengthAssessments    StrengthAssessment[]   @relation("UserStrengthAssessments")
  developmentPlans       DevelopmentPlan[]      @relation("UserDevelopmentPlans")

  // Passkeys / WebAuthn credentials
  webauthnCredentials WebAuthnCredential[]

  // HR Management relations
  leaveRequests         LeaveRequest[]   @relation("UserLeaveRequests")
  approvedLeaveRequests LeaveRequest[]   @relation("ApprovedLeaveRequests")
  createdSchedules      WorkSchedule[]   @relation("CreatedSchedules")
  scheduleEntries       ScheduleEntry[]  @relation("ScheduleEntries")
  timeBank              TimeBank[]
  vacationBalance       VacationBalance?

  // Convites de pacientes enviados
  patientInvites PatientInvite[]

  // Fila de espera (médicos)
  waitingLists WaitingList[]

  // Questionários integrativos
  questionnaireTemplates QuestionnaireTemplate[]
  sentQuestionnaires     PatientQuestionnaire[]  @relation("SentQuestionnaires")

  // Equipe de cuidado
  careTeamMemberships PatientCareTeam[]

  // Combos de exames criados
  examCombos ExamCombo[]

  // Papéis atribuídos (permite que um usuário tenha múltiplos papéis)
  assignedRoles UserAssignedRole[]

  // Telemedicina - Gravações como médico
  doctorRecordings      TelemedicineRecording[] @relation("DoctorRecordings")
  recordingAccessTokens RecordingAccessToken[]

  // Atestados médicos emitidos
  medicalCertificates MedicalCertificate[] @relation("DoctorCertificates")

  // NPS recebidos
  npsResponses NpsResponse[] @relation("DoctorNpsResponses")

  // Assinatura Digital
  digitalCertificates DigitalCertificate[] @relation("UserDigitalCertificates")
  signedDocuments     SignedDocument[]     @relation("UserSignedDocuments")

  // ACS (Agente Comunitário de Saúde) Management
  acsAssignedMicroAreaId String?
  acsAssignedMicroArea   MicroArea? @relation("ACSMicroArea", fields: [acsAssignedMicroAreaId], references: [id], onDelete: SetNull)

  assignedAreaId String?
  assignedArea   Area?   @relation("AssignedArea", fields: [assignedAreaId], references: [id], onDelete: SetNull)

  acsHistory ACSHistory[] @relation("ACSHistoryEntries")

  // SUS Reports
  dailyProductionReports DailyProductionReport[] @relation("DailyProductionReportProfessional")

  // Vaccination Management
  vaccinationsApplied Vaccination[] @relation("VaccinationProfessional")

  // Referrals as destination doctor
  destinationReferrals Referral[] @relation("ReferralDestinationDoctor")

  @@index([acsAssignedMicroAreaId])
  @@index([assignedAreaId])
  @@map("users")
}

model WebAuthnCredential {
  id                      String    @id @default(cuid())
  userId                  String
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialId            String    @unique
  publicKey               String
  counter                 Int       @default(0)
  deviceType              String?
  backedUp                Boolean   @default(false)
  transports              String?
  authenticatorAttachment String?
  nickname                String?
  createdAt               DateTime  @default(now())
  lastUsedAt              DateTime?

  @@index([userId])
  @@map("webauthn_credentials")
}

// Tabela para papéis atribuídos a um usuário
// Permite que administradores atribuam papéis adicionais
model UserAssignedRole {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role // Papel atribuído (ADMIN, DOCTOR, etc.)
  isPrimary  Boolean  @default(false) // Se é o papel principal
  assignedAt DateTime @default(now())
  assignedBy String? // ID do admin que atribuiu

  @@unique([userId, role]) // Um usuário não pode ter o mesmo papel duas vezes
  @@map("user_assigned_roles")
}

model Person {
  id         String    @id @default(cuid())
  name       String
  socialName String?
  cpf        String?   @unique
  birthDate  DateTime?
  gender     Gender?
  motherName String?
  fatherName String?

  // Contact
  email String?
  phone String?

  // Demographics
  ethnicity      String? // IBGE
  educationLevel String?
  occupation     String?
  nationality    String?

  // System Links
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  // Roles
  patient      Patient?
  professional Professional?

  // Address
  addresses PersonAddress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("people")
}

model PersonAddress {
  id        String  @id @default(cuid())
  personId  String
  addressId String
  type      String  @default("RESIDENTIAL") // RESIDENTIAL, COMMERCIAL
  isPrimary Boolean @default(false)
  person    Person  @relation(fields: [personId], references: [id])
  address   Address @relation(fields: [addressId], references: [id])

  @@unique([personId, addressId])
  @@map("person_addresses")
}

model Professional {
  id       String @id @default(cuid())
  personId String @unique
  person   Person @relation(fields: [personId], references: [id])

  registryNumber String? // CNS/CNES
  councilNumber  String? // CRM, COREN
  councilType    String? // CRM, COREN, CRP, etc.
  councilState   String?
  cbo            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("professionals")
}

model Branding {
  id         String   @id @default(cuid())
  clinicName String?
  logoUrl    String?
  headerUrl  String?
  footerText String?
  updatedAt  DateTime @updatedAt
  @@map("branding")
}

model SystemModule {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  isEnabled   Boolean  @default(false)
  features    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_modules")
}

model Patient {
  id                    String                 @id @default(cuid())
  name                  String
  email                 String                 @unique
  cpf                   String?
  birthDate             DateTime
  gender                Gender
  phone                 String?
  address               String?
  emergencyContact      String?
  allergies             String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  currentMedications    String?
  insuranceNumber       String?
  medicalHistory        String?
  riskLevel             RiskLevel              @default(BAIXO)
  userId                String?
  latitude              Float?
  longitude             Float?
  cpfHash               String?                @unique
  householdId           String?
  isHeadOfHousehold     Boolean                @default(false)
  userAccount           User?                  @relation("UserPatient")
  addresses             Address[]
  attachments           Attachment[]
  consultations         Consultation[]
  diagnoses             Diagnosis[]
  ExamRequest           ExamRequest[]
  examResults           ExamResult[]
  financialTransactions FinancialTransaction[]
  documents             MedicalDocument[]
  medicalRecords        MedicalRecord[]
  household             Household?             @relation(fields: [householdId], references: [id])
  User                  User?                  @relation(fields: [userId], references: [id])
  personId              String?                @unique
  person                Person?                @relation(fields: [personId], references: [id])
  prescriptions         Prescription[]
  referrals             Referral[]
  vitalSigns            VitalSigns[]
  strengthAssessments   StrengthAssessment[]   @relation("PatientStrengthAssessments")
  developmentPlans      DevelopmentPlan[]      @relation("PatientDevelopmentPlans")

  // Dispositivos de saúde conectados
  connectedDevices   ConnectedDevice[]
  deviceReadings     DeviceReading[]
  readingThresholds  ReadingThreshold[]
  deviceSyncSessions DeviceSyncSession[]

  // Consentimentos de biometria (LGPD)
  biometricConsents PatientBiometricConsent[]
  consentAuditLogs  ConsentAuditLog[]
  patientInvite     PatientInvite?

  // Questionários integrativos recebidos
  questionnaires PatientQuestionnaire[]

  // Equipe de cuidado do paciente
  careTeam PatientCareTeam[]

  // Convênios médicos do paciente
  insurances PatientInsurance[]

  // Fila de espera
  waitingLists WaitingList[]

  // Gravações de teleconsulta
  telemedicineRecordings TelemedicineRecording[]

  // Atestados médicos
  medicalCertificates MedicalCertificate[]

  // NPS enviados
  npsResponses NpsResponse[]

  // Wellness Dashboard - Patient Experience
  moodLogs                 PatientMoodLog[]         @relation("PatientMoodLogs")
  aptitudes                PatientAptitude[]        @relation("PatientAptitudes")
  badges                   PatientBadge[]           @relation("PatientBadges")
  wellnessDevelopmentPlans PatientDevelopmentPlan[] @relation("PatientWellnessDevelopmentPlans")
  healthEvents             PatientHealthEvent[]     @relation("PatientHealthEvents")
  wellnessScores           PatientWellnessScore[]   @relation("PatientWellnessScores")
  journals                 PatientJournal[]         @relation("PatientJournals")

  // ============================================
  // SSF INTEGRATION - New Relations
  // ============================================
  // Vaccination
  vaccinations Vaccination[]

  // Pregnancy
  pregnancies Pregnancy[]

  // Gynecological History
  gynecologicalHistory GynecologicalHistory[]
  // ============================================

  // PSF/Família Integration
  rg         String? // RG or equivalent ID
  rgState    String? // State where RG was issued
  fatherName String?

  familyNumber     String? // PSF format: "001.0001.0001"
  sequenceInFamily Int? // Order in family (1, 2, 3...)

  // Social Assessment
  socialVulnerability String? // LOW, MEDIUM, HIGH
  economicClass       String? // A, B, C, D, E
  monthlyFamilyIncome Float? // In BRL

  // Location preference
  preferredAddressId String?
  preferredAddress   Address? @relation("PreferredAddress", fields: [preferredAddressId], references: [id], onDelete: SetNull)

  @@index([familyNumber, sequenceInFamily])
  @@index([preferredAddressId])
  @@index([socialVulnerability])
  @@map("patients")
}

model Household {
  id           String   @id @default(cuid())
  name         String
  address      String
  number       String?
  complement   String?
  neighborhood String?
  city         String?
  state        String?
  zipCode      String?
  microArea    String? // Keep for backward compatibility
  familyType   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Geographic hierarchy (new)
  microAreaId  String?
  microAreaObj MicroArea? @relation(fields: [microAreaId], references: [id], onDelete: SetNull)

  areaId String?
  area   Area?   @relation(fields: [areaId], references: [id], onDelete: SetNull)

  // Social indicators
  monthlyIncome      Float?
  economicClass      String? // A, B, C, D, E
  numberOfRooms      Int?
  hasWater           Boolean? @default(false)
  hasElectricity     Boolean? @default(false)
  hasSewage          Boolean? @default(false)
  hasGarbage         Boolean? @default(false)
  vulnerabilityScore Float? // 0-100 scale

  members Patient[]

  @@index([microAreaId])
  @@index([areaId])
  @@index([vulnerabilityScore])
  @@map("households")
}

model Referral {
  id          String  @id @default(cuid())
  patientId   String
  doctorId    String
  specialty   String
  description String
  priority    String  @default("NORMAL")
  status      String  @default("PENDING")
  notes       String?

  // ============================================
  // ENHANCED REFERRAL (SSF Integration)
  // ============================================
  // Consulta de origem
  consultationId String?
  consultation   Consultation? @relation("OriginReferral", fields: [consultationId], references: [id])

  // Unidade de destino
  destinationUnitId String?
  destinationUnit   HealthUnit? @relation("ReferralDestinationUnit", fields: [destinationUnitId], references: [id])

  // Profissional de destino
  destinationDoctorId String?
  destinationDoctor   User?   @relation("ReferralDestinationDoctor", fields: [destinationDoctorId], references: [id])

  // Agendamento
  scheduledDate DateTime?
  attendedDate  DateTime?

  // Urgência detalhada
  urgencyLevel String? // ROUTINE, URGENT, EMERGENCY

  // Contra-referência
  counterReferralId String?   @unique
  counterReferral   Referral? @relation("CounterReferral", fields: [counterReferralId], references: [id])
  originReferral    Referral? @relation("CounterReferral")

  // Resultado do encaminhamento
  outcome      String? // ATTENDED, NO_SHOW, CANCELLED, RESOLVED
  outcomeNotes String?
  // ============================================

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  doctor    User     @relation(fields: [doctorId], references: [id])
  patient   Patient  @relation(fields: [patientId], references: [id])

  @@index([consultationId])
  @@index([destinationUnitId])
  @@index([scheduledDate])
  @@index([status])
  @@map("referrals")
}

model MedicalRecord {
  id             String       @id @default(cuid())
  title          String
  description    String
  diagnosis      String?
  treatment      String?
  notes          String?
  recordType     RecordType
  severity       Severity     @default(LOW)
  isPrivate      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  patientId      String
  doctorId       String
  sourceDocument String?
  deletedAt      DateTime?
  priority       String       @default("NORMAL")
  version        Int          @default(1)
  aiAnalysis     AIAnalysis[]
  attachments    Attachment[]
  doctor         User         @relation(fields: [doctorId], references: [id])
  patient        Patient      @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([doctorId])
  @@index([recordType])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("medical_records")
}

model Consultation {
  id             String             @id @default(cuid())
  scheduledDate  DateTime
  actualDate     DateTime?
  duration       Int?
  type           ConsultationType
  status         ConsultationStatus @default(SCHEDULED)
  chiefComplaint String?
  history        String?
  physicalExam   String?
  assessment     String?
  plan           String?
  notes          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  patientId      String
  doctorId       String
  meetingLink    String?
  videoUrl       String?

  // ============================================
  // CAMPOS DE BI - TIPO DE ATENDIMENTO (SSF)
  // ============================================
  scheduledDemand     Boolean @default(false) // Demanda Agendada
  immediateDemand     Boolean @default(false) // Demanda Imediata
  orientationOnly     Boolean @default(false) // Atendimento para Orientação
  urgencyWithObs      Boolean @default(false) // Urgência com Observação
  continuedCare       Boolean @default(false) // Atendimento Continuado
  prescriptionRenewal Boolean @default(false) // Renovação de Receita
  examEvaluation      Boolean @default(false) // Avaliação de Exame
  homeVisit           Boolean @default(false) // Visita Domiciliar

  // ============================================
  // CAMPOS DE BI - GRUPOS DE ATENDIMENTO (SSF)
  // ============================================
  mentalHealth Boolean @default(false) // Saúde Mental
  alcoholUser  Boolean @default(false) // Usuário de Álcool
  drugUser     Boolean @default(false) // Usuário de Drogas
  hypertension Boolean @default(false) // Hipertensão
  diabetes     Boolean @default(false) // Diabetes
  leprosy      Boolean @default(false) // Hanseníase
  tuberculosis Boolean @default(false) // Tuberculose
  prenatal     Boolean @default(false) // Pré-Natal
  postpartum   Boolean @default(false) // Puerpério
  stdAids      Boolean @default(false) // DST/AIDS
  preventive   Boolean @default(false) // Preventivo
  childCare    Boolean @default(false) // Puericultura

  // ============================================
  // CAMPOS DE BI - CONDUTAS (SSF)
  // ============================================
  laboratory          Boolean @default(false) // Laboratório
  radiology           Boolean @default(false) // Radiologia
  ultrasound          Boolean @default(false) // Ecografia
  obstetricUltrasound Boolean @default(false) // Ecografia Obstétrica
  mammography         Boolean @default(false) // Mamografia
  ecg                 Boolean @default(false) // ECG
  pathology           Boolean @default(false) // Patologia
  physiotherapy       Boolean @default(false) // Fisioterapia
  referralMade        Boolean @default(false) // Referência

  // ============================================
  // RELAÇÕES
  // ============================================
  doctor               User                  @relation(fields: [doctorId], references: [id])
  patient              Patient               @relation(fields: [patientId], references: [id])
  diagnoses            Diagnosis[]
  examRequests         ExamRequest[]
  financialTransaction FinancialTransaction?
  prescriptions        Prescription[]
  vitalSigns           VitalSigns[]

  // Questionários associados a esta consulta
  questionnaires PatientQuestionnaire[]

  // Fila de espera atendida
  waitingList WaitingList?

  // Gravações de telemedicina
  telemedicineRecordings TelemedicineRecording[]

  // Atestados emitidos
  medicalCertificates MedicalCertificate[]

  // NPS da consulta
  npsResponse NpsResponse?

  // ============================================
  // SSF INTEGRATION - New Relations
  // ============================================
  // Prenatal consultation
  prenatalConsultation PreNatalConsultation?

  // Gynecological history
  gynecologicalHistory GynecologicalHistory[]

  // Referrals originated from this consultation
  originReferrals Referral[] @relation("OriginReferral")
  // ============================================

  @@map("consultations")
}

model Prescription {
  id               String             @id @default(cuid())
  medication       String
  dosage           String
  frequency        String
  duration         String
  instructions     String?
  status           PrescriptionStatus @default(ACTIVE)
  startDate        DateTime           @default(now())
  endDate          DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  patientId        String
  doctorId         String
  consultationId   String?
  digitalSignature String?
  consultation     Consultation?      @relation(fields: [consultationId], references: [id])
  doctor           User               @relation(fields: [doctorId], references: [id])
  patient          Patient            @relation(fields: [patientId], references: [id])
  items            PrescriptionItem[]

  @@map("prescriptions")
}

model ExamRequest {
  id             String        @id @default(cuid())
  examType       String
  description    String?
  urgency        Urgency       @default(ROUTINE)
  status         ExamStatus    @default(REQUESTED)
  requestDate    DateTime      @default(now())
  scheduledDate  DateTime?
  completedDate  DateTime?
  results        String?
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  patientId      String
  doctorId       String
  consultationId String?
  attachments    Attachment[]
  consultation   Consultation? @relation(fields: [consultationId], references: [id])
  doctor         User          @relation(fields: [doctorId], references: [id])
  patient        Patient       @relation(fields: [patientId], references: [id])

  @@map("exam_requests")
}

model VitalSigns {
  id               String @id @default(cuid())
  systolicBP       Int?
  diastolicBP      Int?
  heartRate        Int?
  respiratoryRate  Int?
  temperature      Float?
  weight           Float? // Peso em kg
  height           Float? // Altura em cm
  bmi              Float? // IMC calculado
  oxygenSaturation Int?
  bloodGlucose     Int?

  // ============================================
  // ANTHROPOMETRIC MEASUREMENTS (SSF Integration)
  // ============================================
  waistCircumference Float? // Circunferência da cintura (cm)
  hipCircumference   Float? // Circunferência do quadril (cm)
  headCircumference  Float? // Perímetro cefálico (cm) - pediatria
  armCircumference   Float? // Circunferência do braço (cm)

  // BMI Classification
  bmiClassification String? // UNDERWEIGHT, NORMAL, OVERWEIGHT, OBESE_I, OBESE_II, OBESE_III

  // Pediatric specific
  breastfeeding String? // EXCLUSIVE, PREDOMINANT, COMPLEMENTARY, NONE
  weightForAge  String? // Classificação peso/idade (OMS)
  heightForAge  String? // Classificação altura/idade (OMS)
  bmiForAge     String? // Classificação IMC/idade (OMS)

  // Nutritional assessment
  nutritionalStatus String? // NORMAL, MILD_MALNUTRITION, MODERATE_MALNUTRITION, SEVERE_MALNUTRITION, OVERWEIGHT, OBESITY
  // ============================================

  notes          String?
  recordedAt     DateTime      @default(now())
  createdAt      DateTime      @default(now())
  patientId      String
  consultationId String?
  consultation   Consultation? @relation(fields: [consultationId], references: [id])
  patient        Patient       @relation(fields: [patientId], references: [id])

  @@map("vital_signs")
}

model Attachment {
  id              String         @id @default(cuid())
  fileName        String
  originalName    String
  fileSize        Int
  mimeType        String
  filePath        String
  description     String?
  createdAt       DateTime       @default(now())
  medicalRecordId String?
  examRequestId   String?
  patientId       String?
  examRequest     ExamRequest?   @relation(fields: [examRequestId], references: [id])
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])
  Patient         Patient?       @relation(fields: [patientId], references: [id])

  @@map("attachments")
}

model MedicalDocument {
  id            String                @id @default(cuid())
  fileName      String
  content       String
  fileType      DocumentFileType
  status        DocumentProcessStatus @default(PENDING)
  uploadDate    DateTime              @default(now())
  errorMessage  String?
  importResults String?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  patientId     String?
  analysis      DocumentAnalysis?
  patient       Patient?              @relation(fields: [patientId], references: [id])

  @@map("medical_documents")
}

model DocumentAnalysis {
  id               String          @id @default(cuid())
  confidence       Float
  documentType     DocumentType
  patientInfo      String
  extractedData    String
  suggestedActions String
  analysisDate     DateTime        @default(now())
  reviewed         Boolean         @default(false)
  reviewedBy       String?
  reviewedAt       DateTime?
  documentId       String          @unique
  document         MedicalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("document_analysis")
}

model ExamResult {
  id             String   @id @default(cuid())
  examType       String
  results        String
  examDate       DateTime
  sourceDocument String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  patientId      String
  patient        Patient  @relation(fields: [patientId], references: [id])

  @@map("exam_results")
}

model Address {
  id           String   @id @default(cuid())
  street       String
  number       String?
  complement   String?
  neighborhood String? // Keep for backward compatibility
  city         String // Keep for backward compatibility
  state        String // Keep for backward compatibility
  zipCode      String?
  latitude     Float?
  longitude    Float?
  isPrimary    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Old references (backward compatibility)
  patientId   String?
  microAreaId String?

  // New geographic hierarchy (all optional for backward compatibility)
  countryId       String?
  stateId         String?
  cityId          String?
  zoneId          String?
  districtId      String?
  subprefectureId String?
  neighborhoodId  String? // Different from string field above
  areaId          String?

  // Relations - old
  patient            Patient?        @relation(fields: [patientId], references: [id])
  microArea          MicroArea?      @relation(fields: [microAreaId], references: [id])
  residents          PersonAddress[]
  Place              Place[]
  patientsPreferring Patient[]       @relation("PreferredAddress")

  // Relations - new geographic
  country         Country?       @relation(fields: [countryId], references: [code], onDelete: SetNull)
  stateObj        State?         @relation(fields: [stateId], references: [id], onDelete: SetNull)
  cityObj         City?          @relation(fields: [cityId], references: [id], onDelete: SetNull)
  zone            Zone?          @relation(fields: [zoneId], references: [id], onDelete: SetNull)
  district        District?      @relation(fields: [districtId], references: [id], onDelete: SetNull)
  subprefecture   Subprefecture? @relation(fields: [subprefectureId], references: [id], onDelete: SetNull)
  neighborhoodObj Neighborhood?  @relation(fields: [neighborhoodId], references: [id], onDelete: SetNull)
  area            Area?          @relation(fields: [areaId], references: [id], onDelete: SetNull)

  @@index([patientId])
  @@index([microAreaId])
  @@index([countryId])
  @@index([stateId])
  @@index([cityId])
  @@index([zoneId])
  @@index([districtId])
  @@index([neighborhoodId])
  @@index([areaId])
  @@index([latitude, longitude])
  @@index([cityId, zoneId, districtId])
  @@map("addresses")
}

model Place {
  id          String     @id @default(cuid())
  name        String
  description String?
  category    String?
  latitude    Float?
  longitude   Float?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  addressId   String?
  microAreaId String?
  address     Address?   @relation(fields: [addressId], references: [id])
  microArea   MicroArea? @relation(fields: [microAreaId], references: [id])

  @@index([microAreaId])
  @@index([latitude, longitude])
  @@map("places")
}

model MicroArea {
  id          String   @id @default(cuid())
  name        String
  code        String?  @unique
  description String?
  polygonGeo  String?
  centroidLat Float?
  centroidLng Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  maxLat      Float?
  maxLng      Float?
  minLat      Float?
  minLng      Float?

  // Geographic hierarchy
  areaId String?
  area   Area?   @relation(fields: [areaId], references: [id], onDelete: SetNull)

  // ACS assignments
  acsUsers   User[]       @relation("ACSMicroArea")
  acsHistory ACSHistory[] @relation("ACSHistory")
  households Household[]

  addresses Address[]
  revisions MicroAreaRevision[]
  places    Place[]

  @@index([areaId])
  @@index([centroidLat, centroidLng])
  @@index([minLat, maxLat])
  @@index([minLng, maxLng])
  @@map("micro_areas")
}

model MicroAreaRevision {
  id            String    @id @default(cuid())
  microAreaId   String
  previousGeo   String?
  newGeo        String?
  changedByUser String?
  reason        String?
  createdAt     DateTime  @default(now())
  microArea     MicroArea @relation(fields: [microAreaId], references: [id])

  @@index([microAreaId, createdAt])
  @@map("micro_area_revisions")
}

model CodeSystem {
  id          String         @id @default(cuid())
  kind        CodeSystemKind
  name        String
  version     String?
  description String?
  active      Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  codes       MedicalCode[]

  @@unique([kind, version])
  @@map("code_systems")
}

model MedicalCode {
  id                String                   @id @default(cuid())
  systemId          String
  code              String
  display           String
  description       String?
  parentId          String?
  synonyms          String?
  searchableText    String?
  active            Boolean                  @default(true)
  // Campos adicionais do sistema legado SSF
  chapter           String? // Capítulo CID-10 (I-XXII)
  isCategory        Boolean                  @default(false) // Se é categoria principal
  sexRestriction    String? // M=masculino, F=feminino, null=ambos
  crossAsterisk     String? // ETIOLOGY (+) ou MANIFESTATION (*)
  shortDescription  String? // Descrição curta/abreviada
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  primaryIn         Diagnosis[]              @relation("PrimaryCode")
  secondaryIn       DiagnosisSecondaryCode[]
  parent            MedicalCode?             @relation("MedicalCodeHierarchy", fields: [parentId], references: [id])
  children          MedicalCode[]            @relation("MedicalCodeHierarchy")
  system            CodeSystem               @relation(fields: [systemId], references: [id])
  protocolDiagnoses ProtocolDiagnosis[]

  @@unique([systemId, code])
  @@index([code])
  @@index([display])
  @@index([chapter])
  @@index([sexRestriction])
  @@map("medical_codes")
}

model Diagnosis {
  id             String                   @id @default(cuid())
  patientId      String
  consultationId String?
  primaryCodeId  String
  status         DiagnosisStatus          @default(ACTIVE)
  certainty      DiagnosisCertainty       @default(CONFIRMED)
  notes          String?
  onsetDate      DateTime?
  resolvedDate   DateTime?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  consultation   Consultation?            @relation(fields: [consultationId], references: [id])
  patient        Patient                  @relation(fields: [patientId], references: [id])
  primaryCode    MedicalCode              @relation("PrimaryCode", fields: [primaryCodeId], references: [id])
  revisions      DiagnosisRevision[]
  secondaryCodes DiagnosisSecondaryCode[]

  @@index([patientId])
  @@index([consultationId])
  @@map("diagnoses")
}

model DiagnosisSecondaryCode {
  id          String      @id @default(cuid())
  diagnosisId String
  codeId      String
  order       Int         @default(0)
  createdAt   DateTime    @default(now())
  code        MedicalCode @relation(fields: [codeId], references: [id])
  diagnosis   Diagnosis   @relation(fields: [diagnosisId], references: [id], onDelete: Cascade)

  @@unique([diagnosisId, codeId])
  @@index([codeId])
  @@map("diagnosis_secondary_codes")
}

model DiagnosisRevision {
  id              String    @id @default(cuid())
  diagnosisId     String
  previous        Json?
  next            Json?
  changedAt       DateTime  @default(now())
  changedByUserId String?
  reason          String?
  diagnosis       Diagnosis @relation(fields: [diagnosisId], references: [id])

  @@index([diagnosisId, changedAt])
  @@map("diagnosis_revisions")
}

model AIInteraction {
  id         String        @id @default(cuid())
  type       AIRequestType
  prompt     String
  response   String
  confidence Float?
  metadata   Json?
  createdAt  DateTime      @default(now())
  userId     String
  user       User          @relation(fields: [userId], references: [id])

  @@map("ai_interactions")
}

model AIAnalysis {
  id              String        @id @default(cuid())
  analysisType    String
  input           String
  result          String
  confidence      Float
  suggestions     String[]
  metadata        Json?
  createdAt       DateTime      @default(now())
  medicalRecordId String
  medicalRecord   MedicalRecord @relation(fields: [medicalRecordId], references: [id])

  @@map("ai_analysis")
}

model AIQuotaUsage {
  id        String   @id @default(cuid())
  userId    String
  type      String
  date      DateTime
  count     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, type, date])
  @@index([type, date])
  @@map("ai_quota_usage")
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String
  userEmail    String
  userRole     String
  action       String
  resourceId   String?
  ipAddress    String?
  userAgent    String?
  success      Boolean  @default(true)
  errorMessage String?
  createdAt    DateTime @default(now())
  changes      Json?
  metadata     Json?
  resourceType String   @default("MEDICAL_RECORD")

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([resourceId, createdAt])
  @@index([resourceType, createdAt])
  @@index([success, createdAt])
  @@map("audit_logs")
}

model RateLimitLog {
  id        String    @id @default(cuid())
  userId    String
  operation String
  timestamp DateTime  @default(now())
  expiresAt DateTime?

  @@index([userId, operation, timestamp])
  @@index([expiresAt])
  @@map("rate_limit_logs")
}

model ExternalSourceUpdate {
  id            String             @id @default(cuid())
  sourceType    ExternalSourceType
  versionTag    String?
  status        String
  startedAt     DateTime           @default(now())
  finishedAt    DateTime?
  fetchedCount  Int                @default(0)
  insertedCount Int                @default(0)
  updatedCount  Int                @default(0)
  skippedCount  Int                @default(0)
  checksum      String?
  errorMessage  String?
  meta          String?
  retiredCount  Int                @default(0)

  @@index([sourceType, startedAt])
  @@map("external_source_updates")
}

model CBOGroup {
  id          String       @id @default(cuid())
  code        String       @unique
  name        String
  level       Int
  parentId    String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  parent      CBOGroup?    @relation("CBOGroupHierarchy", fields: [parentId], references: [id])
  children    CBOGroup[]   @relation("CBOGroupHierarchy")
  occupations Occupation[]

  @@index([level])
  @@map("cbo_groups")
}

model Occupation {
  id          String    @id @default(cuid())
  code        String    @unique
  title       String
  description String?
  groupId     String?
  synonyms    String?
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  roles       JobRole[]
  group       CBOGroup? @relation(fields: [groupId], references: [id])

  @@index([groupId])
  @@map("occupations")
}

model JobRole {
  id                 String                 @id @default(cuid())
  title              String
  occupationId       String?
  requiredMinStratum StratumLevel
  requiredMaxStratum StratumLevel?
  description        String?
  tasks              String?
  capabilitiesJson   String?
  active             Boolean                @default(true)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  evaluations        CapabilityEvaluation[]
  occupation         Occupation?            @relation(fields: [occupationId], references: [id])
  userAssignments    UserJobRole[]
  stratumProfile     JobStratumProfile?

  @@index([occupationId])
  @@map("job_roles")
}

model UserJobRole {
  id         String   @id @default(cuid())
  userId     String
  jobRoleId  String
  assignedAt DateTime @default(now())
  active     Boolean  @default(true)
  jobRole    JobRole  @relation(fields: [jobRoleId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, jobRoleId])
  @@index([jobRoleId])
  @@map("user_job_roles")
}

model CapabilityEvaluation {
  id               String        @id @default(cuid())
  subjectUserId    String
  evaluatorUserId  String
  jobRoleId        String?
  stratumAssessed  StratumLevel
  potentialStratum StratumLevel?
  timeSpanMonths   Int?
  evidence         String?
  gaps             String?
  recommendations  String?
  createdAt        DateTime      @default(now())
  capabilityScores String?
  evaluatorUser    User          @relation("EvaluatorUser", fields: [evaluatorUserId], references: [id])
  jobRole          JobRole?      @relation(fields: [jobRoleId], references: [id])
  subjectUser      User          @relation(fields: [subjectUserId], references: [id])

  @@index([subjectUserId, createdAt])
  @@index([evaluatorUserId, createdAt])
  @@index([jobRoleId])
  @@map("capability_evaluations")
}

// ========================================
// STRATUM ASSESSMENT SYSTEM (Elliott Jaques)
// ========================================

// Questionário de avaliação de Time Span
model StratumAssessment {
  id                String                      @id @default(cuid())
  userId            String
  assessmentType    AssessmentType              @default(SELF)
  status            AssessmentStatus            @default(IN_PROGRESS)
  calculatedStratum StratumLevel?
  timeSpanMonths    Int? // Horizonte temporal calculado em meses
  confidenceScore   Float? // 0-1, confiança no resultado
  startedAt         DateTime                    @default(now())
  completedAt       DateTime?
  expiresAt         DateTime? // Assessments expiram após 1 ano
  notes             String?
  user              User                        @relation("UserStratumAssessments", fields: [userId], references: [id])
  responses         StratumAssessmentResponse[]

  @@index([userId, status])
  @@index([completedAt])
  @@map("stratum_assessments")
}

// Respostas do questionário
model StratumAssessmentResponse {
  id            String            @id @default(cuid())
  assessmentId  String
  questionId    String
  answer        String // JSON com a resposta
  timeSpanValue Int? // Valor de time span desta resposta em meses
  score         Float? // Score normalizado 0-1
  answeredAt    DateTime          @default(now())
  assessment    StratumAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  question      StratumQuestion   @relation(fields: [questionId], references: [id])

  @@unique([assessmentId, questionId])
  @@index([assessmentId])
  @@map("stratum_assessment_responses")
}

// Banco de questões para avaliação
model StratumQuestion {
  id             String                      @id @default(cuid())
  category       QuestionCategory
  questionText   String
  questionType   QuestionType                @default(SCENARIO)
  options        String // JSON array de opções
  stratumMapping String // JSON mapeando opções para estratos
  weight         Float                       @default(1.0)
  order          Int                         @default(0)
  active         Boolean                     @default(true)
  createdAt      DateTime                    @default(now())
  updatedAt      DateTime                    @updatedAt
  responses      StratumAssessmentResponse[]

  @@index([category, active])
  @@map("stratum_questions")
}

// Perfil de cargo com requisitos de estrato detalhados
model JobStratumProfile {
  id                  String        @id @default(cuid())
  jobRoleId           String        @unique
  minStratum          StratumLevel
  optimalStratum      StratumLevel
  maxStratum          StratumLevel?
  timeSpanMinMonths   Int // Horizonte mínimo necessário
  timeSpanMaxMonths   Int? // Horizonte máximo (para não sub-utilizar)
  complexityFactors   String? // JSON com fatores de complexidade
  keyResponsibilities String? // JSON com responsabilidades-chave
  decisionTypes       String? // JSON com tipos de decisões
  cboCode             String? // Código CBO relacionado
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  jobRole             JobRole       @relation(fields: [jobRoleId], references: [id])

  @@map("job_stratum_profiles")
}

enum AssessmentType {
  SELF // Auto-avaliação
  MANAGER // Avaliação pelo gestor
  PEER // Avaliação por par
  EXTERNAL // Avaliação externa/consultor
}

enum AssessmentStatus {
  IN_PROGRESS
  COMPLETED
  EXPIRED
  CANCELLED
}

enum QuestionCategory {
  TIME_HORIZON // Horizonte temporal de planejamento
  COMPLEXITY // Complexidade de problemas
  ABSTRACTION // Nível de abstração
  UNCERTAINTY // Tolerância à ambiguidade
  DECISION_MAKING // Tomada de decisão
  LEADERSHIP // Estilo de liderança
}

enum QuestionType {
  SCENARIO // Cenário situacional
  SCALE // Escala likert
  RANKING // Ordenação de prioridades
  OPEN // Resposta aberta (para análise)
}

// ========================================
// CHARACTER STRENGTHS & GEMS SYSTEM
// ========================================

// Forças de Caráter (baseado no VIA Survey)
model CharacterStrength {
  id          String  @id @default(cuid())
  code        String  @unique // ex: "CREATIVITY", "CURIOSITY"
  name        String // Nome em português
  virtue      Virtue // Virtude associada
  description String
  examples    String? // JSON com exemplos de aplicação
  healthTips  String? // JSON com dicas de saúde relacionadas
  order       Int     @default(0)
  active      Boolean @default(true)

  assessmentResults StrengthAssessmentResult[]

  @@map("character_strengths")
}

// Assessment de Forças de Caráter
model StrengthAssessment {
  id             String                       @id @default(cuid())
  userId         String?
  patientId      String?
  assessmentType AssessmentType               @default(SELF)
  status         AssessmentStatus             @default(IN_PROGRESS)
  startedAt      DateTime                     @default(now())
  completedAt    DateTime?
  notes          String?
  user           User?                        @relation("UserStrengthAssessments", fields: [userId], references: [id])
  patient        Patient?                     @relation("PatientStrengthAssessments", fields: [patientId], references: [id])
  results        StrengthAssessmentResult[]
  responses      StrengthAssessmentResponse[]

  @@index([userId, status])
  @@index([patientId, status])
  @@map("strength_assessments")
}

// Respostas do questionário de forças
model StrengthAssessmentResponse {
  id           String             @id @default(cuid())
  assessmentId String
  questionId   String
  answer       String // JSON
  score        Float?
  answeredAt   DateTime           @default(now())
  assessment   StrengthAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  question     StrengthQuestion   @relation(fields: [questionId], references: [id])

  @@unique([assessmentId, questionId])
  @@map("strength_assessment_responses")
}

// Questões para avaliação de forças
model StrengthQuestion {
  id             String                       @id @default(cuid())
  strengthCode   String // Código da força avaliada
  questionText   String
  questionType   QuestionType                 @default(SCALE)
  options        String // JSON
  targetAudience TargetAudience               @default(BOTH)
  order          Int                          @default(0)
  active         Boolean                      @default(true)
  responses      StrengthAssessmentResponse[]

  @@index([strengthCode, active])
  @@map("strength_questions")
}

// Resultado consolidado por força
model StrengthAssessmentResult {
  id           String             @id @default(cuid())
  assessmentId String
  strengthId   String
  score        Float // 0-5
  rank         Int? // Posição no ranking (1 = mais forte)
  isTopFive    Boolean            @default(false)
  isGem        Boolean            @default(false) // Gema bruta identificada
  assessment   StrengthAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  strength     CharacterStrength  @relation(fields: [strengthId], references: [id])

  @@unique([assessmentId, strengthId])
  @@map("strength_assessment_results")
}

// Plano de Desenvolvimento Pessoal
model DevelopmentPlan {
  id               String                 @id @default(cuid())
  userId           String?
  patientId        String?
  title            String
  futureVision     String? // Visão de futuro do indivíduo
  currentStratum   StratumLevel?
  targetStratum    StratumLevel?
  primaryStrengths String? // JSON com forças principais a alavancar
  developmentAreas String? // JSON com áreas de desenvolvimento
  status           PlanStatus             @default(ACTIVE)
  startDate        DateTime               @default(now())
  targetDate       DateTime?
  completedAt      DateTime?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  user             User?                  @relation("UserDevelopmentPlans", fields: [userId], references: [id])
  patient          Patient?               @relation("PatientDevelopmentPlans", fields: [patientId], references: [id])
  goals            DevelopmentGoal[]
  milestones       DevelopmentMilestone[]

  @@index([userId, status])
  @@index([patientId, status])
  @@map("development_plans")
}

// Metas do Plano de Desenvolvimento
model DevelopmentGoal {
  id           String          @id @default(cuid())
  planId       String
  title        String
  description  String?
  category     GoalCategory
  strengthCode String? // Força de caráter relacionada
  targetDate   DateTime?
  status       GoalStatus      @default(NOT_STARTED)
  progress     Int             @default(0) // 0-100
  completedAt  DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  plan         DevelopmentPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  actions      GoalAction[]

  @@index([planId, status])
  @@map("development_goals")
}

// Ações para alcançar metas
model GoalAction {
  id          String          @id @default(cuid())
  goalId      String
  title       String
  description String?
  frequency   ActionFrequency @default(DAILY)
  dueDate     DateTime?
  completed   Boolean         @default(false)
  completedAt DateTime?
  createdAt   DateTime        @default(now())
  goal        DevelopmentGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId, completed])
  @@map("goal_actions")
}

// Marcos de progresso
model DevelopmentMilestone {
  id          String          @id @default(cuid())
  planId      String
  title       String
  description String?
  targetDate  DateTime?
  achieved    Boolean         @default(false)
  achievedAt  DateTime?
  celebration String? // Mensagem de celebração
  createdAt   DateTime        @default(now())
  plan        DevelopmentPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId, achieved])
  @@map("development_milestones")
}

enum Virtue {
  WISDOM // Sabedoria
  COURAGE // Coragem
  HUMANITY // Humanidade
  JUSTICE // Justiça
  TEMPERANCE // Temperança
  TRANSCENDENCE // Transcendência
}

enum TargetAudience {
  STAFF // Apenas colaboradores
  PATIENT // Apenas pacientes
  BOTH // Ambos
}

enum PlanStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum GoalCategory {
  HEALTH // Saúde física
  MENTAL // Saúde mental
  CAREER // Carreira/profissional
  RELATIONSHIPS // Relacionamentos
  PERSONAL // Desenvolvimento pessoal
  SPIRITUAL // Espiritual/propósito
}

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ActionFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  ONCE
}

model FinancialTransaction {
  id             String            @id @default(cuid())
  type           TransactionType
  amount         Decimal           @db.Decimal(10, 2)
  description    String
  category       String
  status         TransactionStatus @default(PENDING)
  dueDate        DateTime
  paidDate       DateTime?
  paymentMethod  String?
  patientId      String?
  consultationId String?           @unique
  insuranceId    String? // Link to insurance/convenio
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  consultation   Consultation?     @relation(fields: [consultationId], references: [id])
  patient        Patient?          @relation(fields: [patientId], references: [id])
  insurance      HealthInsurance?  @relation(fields: [insuranceId], references: [id])

  @@map("financial_transactions")
}

model HealthInsurance {
  id                 String                 @id @default(cuid())
  name               String // Nome do convênio (ex: Unimed, SulAmérica)
  type               InsuranceType          @default(PRIVATE)
  code               String?                @unique // Código ANS
  contactPhone       String?
  contactEmail       String?
  billingAddress     String?
  isActive           Boolean                @default(true)
  coveragePercentage Int                    @default(100) // % coberto
  copayAmount        Decimal?               @db.Decimal(10, 2) // Valor da coparticipação
  notes              String?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  patients           PatientInsurance[]
  transactions       FinancialTransaction[]

  @@map("health_insurances")
}

model PatientInsurance {
  id          String          @id @default(cuid())
  patientId   String
  insuranceId String
  cardNumber  String? // Número da carteirinha
  validUntil  DateTime? // Validade
  plan        String? // Tipo de plano
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  patient     Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  insurance   HealthInsurance @relation(fields: [insuranceId], references: [id])

  @@unique([patientId, insuranceId])
  @@map("patient_insurances")
}

model DoctorSchedule {
  id                    String   @id @default(cuid())
  doctorId              String
  dayOfWeek             Int
  startTime             String
  endTime               String
  slotDuration          Int      @default(30)
  // Patient booking settings
  allowPatientBooking   Boolean  @default(false)
  maxBookingDaysAhead   Int      @default(30)    // Quantos dias antes permite agendar
  minBookingHoursAhead  Int      @default(24)    // Quantas horas antes permite agendar
  autoConfirmBooking    Boolean  @default(false) // Confirma automaticamente ou requer aprovação
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  doctor                User     @relation(fields: [doctorId], references: [id])

  @@unique([doctorId, dayOfWeek])
  @@map("doctor_schedules")
}

model ScheduleException {
  id          String   @id @default(cuid())
  doctorId    String
  date        DateTime
  blockType   BlockType @default(UNAVAILABLE) // Tipo de bloqueio
  reason      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  doctor      User     @relation(fields: [doctorId], references: [id])

  @@index([doctorId, date])
  @@map("schedule_exceptions")
}

enum BlockType {
  UNAVAILABLE    // Indisponível geral
  ON_CALL        // Plantão (em outro serviço)
  VACATION       // Férias
  SICK_LEAVE     // Licença médica
  MAINTENANCE    // Manutenção/admin
  TRAINING       // Treinamento
  MEETING        // Reunião/conferência
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  priority  String    @default("low")
  title     String
  message   String
  read      Boolean   @default(false)
  metadata  Json?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId, read])
  @@map("notifications")
}

model CIAP2 {
  code        String  @id
  description String
  chapter     String
  gender      String?
  active      Boolean @default(true)

  @@map("ciap2")
}

model Territory {
  id       String      @id @default(cuid())
  name     String
  type     String // 'MUNICIPALITY', 'DISTRICT', 'UNIT', 'TEAM_AREA', 'MICRO_AREA'
  parentId String?
  parent   Territory?  @relation("TerritoryHierarchy", fields: [parentId], references: [id])
  children Territory[] @relation("TerritoryHierarchy")

  // GeoJSON geometry stored as JSON
  geometry Json?

  // Center point for quick lookup
  centerLat Float?
  centerLng Float?

  // Hierarchy
  level Int? // 1=Municipality, 2=District, 3=Subprefecture, 4=Area, 5=MicroArea

  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([parentId])
  @@map("territories")
}

enum DocumentFileType {
  DOCX
  DOC
  PDF
  TXT
  RTF
}

enum DocumentProcessStatus {
  PENDING
  ANALYZING
  CLASSIFIED
  IMPORTED
  ERROR
}

enum DocumentType {
  EVOLUCAO
  EXAME
  PRESCRICAO
  ANAMNESE
  ATESTADO
  RECEITA
  LAUDO
  OUTROS
}

enum Role {
  ADMIN
  DOCTOR
  NURSE
  RECEPTIONIST
  PHYSIOTHERAPIST
  PSYCHOLOGIST
  HEALTH_AGENT
  TECHNICIAN
  PHARMACIST
  DENTIST
  NUTRITIONIST
  SOCIAL_WORKER
  OTHER
  PATIENT
}

model RegistrationInvite {
  id        String       @id @default(cuid())
  email     String
  role      Role
  token     String       @unique
  expiresAt DateTime
  status    InviteStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("registration_invites")
}

enum InviteStatus {
  PENDING
  USED
  EXPIRED
}

model Term {
  id       String  @id @default(cuid())
  slug     String  @unique
  title    String
  content  String  @db.Text
  version  String
  isActive Boolean @default(true)

  acceptances TermAcceptance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("terms")
}

model TermAcceptance {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])
  termId String
  term   Term   @relation(fields: [termId], references: [id])

  acceptedAt DateTime @default(now())
  ipAddress  String?
  userAgent  String?

  @@map("term_acceptances")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum RiskLevel {
  BAIXO
  MEDIO
  ALTO
  CRITICO
}

enum BloodType {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum RecordType {
  CONSULTATION
  EXAM
  PRESCRIPTION
  DIAGNOSIS
  TREATMENT
  SURGERY
  EMERGENCY
  FOLLOW_UP
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ConsultationType {
  INITIAL
  FOLLOW_UP
  EMERGENCY
  ROUTINE
  SPECIALIST
}

enum ConsultationStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PrescriptionStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  EXPIRED
}

enum ExamStatus {
  REQUESTED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Urgency {
  ROUTINE
  URGENT
  EMERGENCY
}

enum AIRequestType {
  DIAGNOSIS_SUGGESTION
  TREATMENT_RECOMMENDATION
  DRUG_INTERACTION_CHECK
  SYMPTOM_ANALYSIS
  MEDICAL_SUMMARY
  RISK_ASSESSMENT
}

enum CodeSystemKind {
  CID10
  CID11
  CIAP2
  NURSING
}

enum DiagnosisStatus {
  ACTIVE
  RESOLVED
  ENTERED_IN_ERROR
  INACTIVE
}

enum DiagnosisCertainty {
  SUSPECTED
  PROBABLE
  CONFIRMED
  RULED_OUT
}

enum ExternalSourceType {
  ICD10
  ICD11
  CIAP2
  NURSING
  CBO
}

enum StratumLevel {
  S1
  S2
  S3
  S4
  S5
  S6
  S7
  S8
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionStatus {
  PENDING
  PAID
  CANCELLED
  OVERDUE
}

enum InsuranceType {
  PRIVATE // Convênio particular
  SUS // Sistema Único de Saúde
  CORPORATE // Convênio empresarial
  OTHER
}

model SystemSetting {
  key         String   @id
  value       String   @db.Text // Suporte a valores grandes
  description String?
  category    String   @default("GENERAL") // EMAIL, SECURITY, SYSTEM, STORAGE, WHATSAPP, REDIS, WEBRTC
  isPublic    Boolean  @default(false)
  encrypted   Boolean  @default(false) // Se o valor está criptografado
  updatedBy   String? // ID do usuário que atualizou
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@map("system_settings")
}

// ==================== HR MANAGEMENT ====================

// Tipos de ausência
enum LeaveType {
  VACATION // Férias
  SICK_LEAVE // Licença médica
  MATERNITY // Licença maternidade
  PATERNITY // Licença paternidade
  BEREAVEMENT // Luto
  PERSONAL // Particular
  TRAINING // Treinamento/Capacitação
  COMPENSATORY // Folga compensatória
  OTHER // Outro
}

// Status da solicitação de ausência
enum LeaveStatus {
  PENDING // Aguardando aprovação
  APPROVED // Aprovado
  REJECTED // Rejeitado
  CANCELLED // Cancelado
  IN_PROGRESS // Em andamento
  COMPLETED // Finalizado
}

// Solicitação de férias/folgas/licenças
model LeaveRequest {
  id     String @id @default(cuid())
  userId String
  user   User   @relation("UserLeaveRequests", fields: [userId], references: [id])

  type      LeaveType
  startDate DateTime
  endDate   DateTime
  reason    String?

  status LeaveStatus @default(PENDING)

  // Aprovação
  approvedBy    String?
  approver      User?     @relation("ApprovedLeaveRequests", fields: [approvedBy], references: [id])
  approvedAt    DateTime?
  rejectionNote String?

  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("leave_requests")
}

// Tipo de turno
enum ShiftType {
  MORNING // Manhã (6h-12h)
  AFTERNOON // Tarde (12h-18h)
  EVENING // Noite (18h-24h)
  NIGHT // Madrugada (0h-6h)
  FULL_DAY // Dia inteiro
  ON_CALL // Plantão/Sobreaviso
  CUSTOM // Personalizado
}

// Escala de trabalho
model WorkSchedule {
  id          String  @id @default(cuid())
  name        String // Ex: "Escala Médicos Janeiro 2025"
  description String?

  startDate DateTime // Período da escala
  endDate   DateTime

  isActive  Boolean @default(true)
  createdBy String
  creator   User    @relation("CreatedSchedules", fields: [createdBy], references: [id])

  entries ScheduleEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("work_schedules")
}

// Entrada na escala (profissional + turno + data)
model ScheduleEntry {
  id         String       @id @default(cuid())
  scheduleId String
  schedule   WorkSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("ScheduleEntries", fields: [userId], references: [id])

  date      DateTime // Data específica
  shiftType ShiftType
  startTime String? // Horário personalizado (formato HH:mm)
  endTime   String?

  notes       String?
  isConfirmed Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([scheduleId, userId, date])
  @@map("schedule_entries")
}

// Banco de horas
model TimeBank {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  date        DateTime // Data da movimentação
  minutes     Int // Positivo = crédito, Negativo = débito
  description String

  // Referência opcional a entrada de escala
  scheduleEntryId String?

  createdAt DateTime @default(now())

  @@map("time_bank")
}

// Saldo de férias
model VacationBalance {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  totalDays   Int @default(30) // Total de dias de férias por período
  usedDays    Int @default(0) // Dias já utilizados
  pendingDays Int @default(0) // Dias em solicitações pendentes

  referenceYear Int // Ano de referência (período aquisitivo)
  expiresAt     DateTime? // Data limite para uso

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("vacation_balances")
}

// ==================== INVENTORY MANAGEMENT ====================

// Unidade de medida
enum MeasureUnit {
  UNIT // Unidade
  BOX // Caixa
  PACK // Pacote
  BOTTLE // Frasco
  AMPULE // Ampola
  TUBE // Tubo
  BAG // Bolsa
  KIT // Kit
  LITER // Litro
  ML // Mililitro
  GRAM // Grama
  KG // Quilograma
  METER // Metro
  CM // Centímetro
  ROLL // Rolo
  PAIR // Par
}

// Categoria de produto
model ProductCategory {
  id          String            @id @default(cuid())
  name        String            @unique
  description String?
  parentId    String?
  parent      ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ProductCategory[] @relation("CategoryHierarchy")
  products    Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product_categories")
}

// Produto/Material
model Product {
  id          String  @id @default(cuid())
  code        String  @unique // Código interno
  barcode     String? @unique // Código de barras
  name        String
  description String?

  categoryId String?
  category   ProductCategory? @relation(fields: [categoryId], references: [id])

  unit         MeasureUnit @default(UNIT)
  minStock     Int         @default(0) // Estoque mínimo
  maxStock     Int? // Estoque máximo
  reorderPoint Int? // Ponto de reposição

  isActive     Boolean @default(true)
  isControlled Boolean @default(false) // Medicamento controlado
  requiresLot  Boolean @default(false) // Requer controle de lote

  // Pricing
  costPrice Float? // Preço de custo
  sellPrice Float? // Preço de venda (se aplicável)

  // Inventory relation
  inventory Inventory[]
  movements InventoryMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("products")
}

// Tipo de movimentação
enum MovementType {
  ENTRY // Entrada
  EXIT // Saída
  ADJUSTMENT_IN // Ajuste entrada
  ADJUSTMENT_OUT // Ajuste saída
  TRANSFER_IN // Transferência entrada
  TRANSFER_OUT // Transferência saída
  LOSS // Perda/Avaria
  RETURN // Devolução
  CONSUMPTION // Consumo (uso em atendimento)
}

// Localização/Almoxarifado
model StorageLocation {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  isActive    Boolean @default(true)

  inventory     Inventory[]
  movementsFrom InventoryMovement[] @relation("MovementFrom")
  movementsTo   InventoryMovement[] @relation("MovementTo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("storage_locations")
}

// Estoque (quantidade por localização)
model Inventory {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])

  locationId String
  location   StorageLocation @relation(fields: [locationId], references: [id])

  quantity    Int @default(0)
  reservedQty Int @default(0) // Quantidade reservada

  // Lote (se aplicável)
  lotNumber      String?
  expirationDate DateTime?

  lastCountDate DateTime? // Última contagem física
  lastCountQty  Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, locationId, lotNumber])
  @@map("inventory")
}

// Movimentação de estoque
model InventoryMovement {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])

  type     MovementType
  quantity Int

  // Localização origem (para saídas/transferências)
  fromLocationId String?
  fromLocation   StorageLocation? @relation("MovementFrom", fields: [fromLocationId], references: [id])

  // Localização destino (para entradas/transferências)
  toLocationId String?
  toLocation   StorageLocation? @relation("MovementTo", fields: [toLocationId], references: [id])

  // Lote
  lotNumber      String?
  expirationDate DateTime?

  // Referência
  referenceType String? // 'consultation', 'purchase', 'transfer', etc.
  referenceId   String?

  // Custo
  unitCost  Float?
  totalCost Float?

  notes String?

  // Usuário que registrou
  userId String

  createdAt DateTime @default(now())

  @@map("inventory_movements")
}

// Fornecedor
model Supplier {
  id        String  @id @default(cuid())
  name      String
  tradeName String? // Nome fantasia
  document  String? @unique // CNPJ

  // Contato
  email   String?
  phone   String?
  website String?

  // Endereço
  address String?
  city    String?
  state   String?
  zipCode String?

  // Dados bancários
  bankInfo String?

  notes    String?
  isActive Boolean @default(true)

  purchaseOrders PurchaseOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("suppliers")
}

// Status de pedido de compra
enum PurchaseOrderStatus {
  DRAFT // Rascunho
  PENDING // Aguardando aprovação
  APPROVED // Aprovado
  ORDERED // Pedido feito
  PARTIAL // Recebido parcialmente
  RECEIVED // Recebido
  CANCELLED // Cancelado
}

// Pedido de compra
model PurchaseOrder {
  id          String @id @default(cuid())
  orderNumber String @unique

  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  status PurchaseOrderStatus @default(DRAFT)

  // Datas
  orderDate    DateTime?
  expectedDate DateTime?
  receivedDate DateTime?

  // Valores
  subtotal Float @default(0)
  discount Float @default(0)
  shipping Float @default(0)
  total    Float @default(0)

  notes String?

  // Usuários
  createdBy  String
  approvedBy String?

  items PurchaseOrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("purchase_orders")
}

// Item do pedido de compra
model PurchaseOrderItem {
  id      String        @id @default(cuid())
  orderId String
  order   PurchaseOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String

  quantity    Int
  receivedQty Int   @default(0)
  unitPrice   Float
  totalPrice  Float

  lotNumber      String?
  expirationDate DateTime?

  createdAt DateTime @default(now())

  @@map("purchase_order_items")
}

// =====================================================
// SISTEMA DE MEDICAMENTOS (Importado do SSF)
// =====================================================

model Medication {
  id        String  @id @default(cuid())
  name      String // Nome do medicamento
  synonym   String? // Sinônimo / nome alternativo
  tradeName String? // Nome comercial / fantasia

  // Classificação da receita
  prescriptionType PrescriptionType @default(SYMPTOMATIC)

  // Disponibilidade nas farmácias
  basicPharmacy      Boolean @default(false) // Farmácia da Unidade
  municipalPharmacy  Boolean @default(false) // Farmácia Municipal
  statePharmacy      Boolean @default(false) // Farmácia Estadual
  homePharmacy       Boolean @default(false) // Internação Domiciliar
  popularPharmacy    Boolean @default(false) // Farmácia Popular
  hospitalPharmacy   Boolean @default(false) // Farmácia Hospitalar
  commercialPharmacy Boolean @default(false) // Farmácia Comercial
  compoundPharmacy   Boolean @default(false) // Farmácia de Manipulação

  // Código SUS
  susCode String?

  // Informações de uso
  instructions String? // Orientação de uso padrão
  notes        String? // Notas
  description  String? // Descrição
  warnings     String? // Advertências
  interactions String? // Interações medicamentosas
  observations String? // Observações

  // Restrições
  minAge         Int? // Idade mínima
  maxAge         Int? // Idade máxima
  sexRestriction String? // M=masculino, F=feminino, null=ambos
  validityDays   Int? // Validade em dias

  // Informações da apresentação
  route       String? // Via de administração (Oral, IM, etc)
  strength    String? // Concentração (ex: 500mg)
  unit        String? // Unidade (mg, mL, etc)
  form        String? // Forma farmacêutica (comprimido, solução, etc)
  packaging   String? // Recipiente (cp, fr, amp, tb, etc)
  packageSize Int? // Capacidade do recipiente

  // Dosagem padrão
  dosePerKg         Float? // Dose por kg
  maxDailyDosePerKg Float? // Dose máxima diária por kg
  defaultFrequency  Float? // Frequência padrão
  defaultDuration   Int? // Duração padrão do tratamento
  maxQuantity       Float? // Quantidade máxima

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  prescriptionItems     PrescriptionItem[]
  protocolPrescriptions ProtocolPrescription[]

  @@index([name])
  @@index([susCode])
  @@map("medications")
}

enum PrescriptionType {
  SYMPTOMATIC // Sintomático
  CONTINUOUS // Contínuo
  CONTROLLED // Controlado
  BLUE_B // Tipo B - Azul
  YELLOW_A // Tipo A - Amarelo
  PHYTOTHERAPIC // Fitoterápico
}

model PrescriptionItem {
  id             String  @id @default(cuid())
  prescriptionId String
  medicationId   String?

  // Se não usar medicação do catálogo
  customName String?

  dosage       String
  frequency    String
  duration     String
  quantity     Int?
  instructions String?

  prescription      Prescription       @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  medication        Medication?        @relation(fields: [medicationId], references: [id])
  medicationTakings MedicationTaking[] // Histórico de tomadas

  createdAt DateTime @default(now())

  @@map("prescription_items")
}

// =====================================================
// FÓRMULAS MAGISTRAIS (Templates de Manipulação)
// =====================================================

model FormulaTemplate {
  id          String  @id @default(cuid())
  name        String // Nome da fórmula
  category    String // Categoria (Endocrinologia, Gastrointestinal, etc)
  ingredients String // Ingredientes com doses (Vitamina D3 10.000 UI | K2 120 mcg)
  form        String // Forma farmacêutica (Cápsula, Solução, Creme, etc)
  dosage      String // Posologia sugerida
  notes       String? // Notas técnicas

  // Informações clínicas expandidas (do PDF)
  indications       String? // Indicações clínicas
  contraindications String? // Contraindicações
  sideEffects       String? // Efeitos adversos
  interactions      String? // Interações medicamentosas
  monitoring        String? // Exames/monitoramento recomendado
  duration          String? // Duração sugerida do tratamento

  // Metadados
  source   String? // Fonte (Singularis, Vitalis, CSV, etc)
  pharmacy String? // Farmácia recomendada

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([category])
  @@map("formula_templates")
}

// =====================================================
// SISTEMA DE PROCEDIMENTOS SIGTAP (Importado do SSF)
// =====================================================

model Procedure {
  id             String  @id @default(cuid())
  code           String  @unique // Código SIGTAP (10 dígitos)
  name           String
  complexity     Int? // Complexidade (0-3)
  financing      String? // Financiamento (N=Nacional, I=Municipal, F=Federal)
  minAge         Int? // Idade mínima (em meses)
  maxAge         Int? // Idade máxima (em meses)
  sexRestriction String? // M=masculino, F=feminino, null=ambos

  // Agrupamentos
  group    String? // Grupo do procedimento
  subgroup String? // Subgrupo

  // CBO relacionado
  cboRequired String? // CBO necessário para realizar

  active    Boolean   @default(true)
  validFrom DateTime? // Data de vigência
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([code])
  @@index([name])
  @@map("procedures")
}

// =====================================================
// CATÁLOGO DE EXAMES (Importado do SSF)
// =====================================================

model ExamCatalog {
  id           String  @id @default(cuid())
  name         String
  abbreviation String? // Abreviação (ex: HMG, GLI)
  description  String?

  // Tipo de exame
  examCategory ExamCategory

  // Restrições
  minAge         Int?
  maxAge         Int?
  sexRestriction String? // M=masculino, F=feminino, null=ambos

  // Código SUS relacionado
  susCode String?

  // Preparação
  preparation String? // Instruções de preparo

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  protocolExams  ProtocolExam[]
  examComboItems ExamComboItem[] // Combos que incluem este exame

  @@index([name])
  @@index([examCategory])
  @@map("exam_catalog")
}

// ============================================
// COMBOS/PACOTES DE EXAMES
// ============================================

model ExamCombo {
  id          String        @id @default(cuid())
  name        String // Nome do combo (ex: "Check-up Básico", "Perfil Lipídico")
  description String? // Descrição do combo
  category    ExamCategory? // Categoria principal do combo

  // Configurações
  isActive Boolean @default(true)
  isPublic Boolean @default(true) // Disponível para todos os médicos

  // Criador (opcional - combos do sistema não têm criador)
  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])

  // Exames do combo
  items ExamComboItem[]

  // Metadados
  usageCount Int      @default(0) // Quantas vezes foi usado
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([name])
  @@index([category])
  @@index([isActive])
  @@map("exam_combos")
}

model ExamComboItem {
  id String @id @default(cuid())

  // Relacionamentos
  comboId String
  combo   ExamCombo @relation(fields: [comboId], references: [id], onDelete: Cascade)

  examId String
  exam   ExamCatalog @relation(fields: [examId], references: [id], onDelete: Cascade)

  // Ordem do exame no combo
  order Int @default(0)

  // Configurações específicas
  notes      String? // Notas específicas para este exame no combo
  isRequired Boolean @default(true) // Se o exame é obrigatório ou opcional

  createdAt DateTime @default(now())

  @@unique([comboId, examId]) // Um exame só pode estar uma vez em cada combo
  @@index([comboId])
  @@index([examId])
  @@map("exam_combo_items")
}

enum ExamCategory {
  LABORATORY // Laboratório
  RADIOLOGY // Radiografia
  ECG // Eletrocardiograma
  PHYSIOTHERAPY // Fisioterapia
  APAC // APAC
  CYTOPATHOLOGY // Citopatológico
  MAMMOGRAPHY // Mamografia
  ULTRASOUND // Ecografia/Ultrassonografia
  LAB_ALTERNATIVE // Laboratório Alternativo
  RAD_ALTERNATIVE // Radiografia Alternativa
  OTHER_1 // Outros 1
  OTHER_2 // Outros 2
}

// ============================================
// PROTOCOLOS E PREFERÊNCIAS DO MÉDICO
// ============================================

model Protocol {
  id          String           @id @default(cuid())
  name        String // Nome do protocolo (ex: "Hipertensão - Inicial")
  description String? // Descrição do protocolo
  category    ProtocolCategory @default(CUSTOM)

  // Criador
  doctorId String
  doctor   User   @relation(fields: [doctorId], references: [id])

  // Configurações
  isPublic   Boolean @default(false) // Compartilhado com outros médicos
  isActive   Boolean @default(true)
  usageCount Int     @default(0) // Quantas vezes foi usado

  // Items do protocolo
  prescriptions ProtocolPrescription[]
  exams         ProtocolExam[]
  referrals     ProtocolReferral[]
  diagnoses     ProtocolDiagnosis[]

  // Metadados
  tags      String[] // Tags para busca
  specialty String? // Especialidade relacionada

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([doctorId])
  @@index([category])
  @@index([name])
  @@map("protocols")
}

model ProtocolPrescription {
  id         String   @id @default(cuid())
  protocolId String
  protocol   Protocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)

  // Medicação do catálogo (opcional)
  medicationId String?
  medication   Medication? @relation(fields: [medicationId], references: [id])

  // Dados da prescrição
  medicationName String // Nome (pode ser diferente do catálogo)
  dosage         String // Dosagem
  frequency      String // Frequência
  duration       String // Duração
  instructions   String? // Orientações
  quantity       Float? // Quantidade
  route          String? // Via de administração

  // Ordem no protocolo
  sortOrder Int @default(0)

  @@index([protocolId])
  @@map("protocol_prescriptions")
}

model ProtocolExam {
  id         String   @id @default(cuid())
  protocolId String
  protocol   Protocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)

  // Exame do catálogo (opcional)
  examCatalogId String?
  examCatalog   ExamCatalog? @relation(fields: [examCatalogId], references: [id])

  // Dados do exame
  examName    String // Nome do exame
  description String? // Indicação/descrição
  priority    Urgency @default(ROUTINE)
  notes       String? // Observações

  // Ordem no protocolo
  sortOrder Int @default(0)

  @@index([protocolId])
  @@map("protocol_exams")
}

model ProtocolReferral {
  id         String   @id @default(cuid())
  protocolId String
  protocol   Protocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)

  // Dados do encaminhamento
  specialty   String // Especialidade
  description String // Motivo/indicação
  priority    Urgency @default(ROUTINE)
  notes       String? // Observações

  // Ordem no protocolo
  sortOrder Int @default(0)

  @@index([protocolId])
  @@map("protocol_referrals")
}

model ProtocolDiagnosis {
  id         String   @id @default(cuid())
  protocolId String
  protocol   Protocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)

  // CID do catálogo
  medicalCodeId String?
  medicalCode   MedicalCode? @relation(fields: [medicalCodeId], references: [id])

  // Dados do diagnóstico
  cidCode     String // Código CID
  description String // Descrição
  isPrimary   Boolean @default(false) // Diagnóstico principal

  // Ordem no protocolo
  sortOrder Int @default(0)

  @@index([protocolId])
  @@map("protocol_diagnoses")
}

enum ProtocolCategory {
  HYPERTENSION // Hipertensão
  DIABETES // Diabetes
  PRENATAL // Pré-natal
  CHILDCARE // Puericultura
  MENTAL_HEALTH // Saúde Mental
  RESPIRATORY // Doenças Respiratórias
  INFECTIOUS // Doenças Infecciosas
  CHRONIC // Doenças Crônicas
  PREVENTIVE // Medicina Preventiva
  EMERGENCY // Urgência/Emergência
  CUSTOM // Personalizado
}

// ============================================
// DISPOSITIVOS DE SAÚDE CONECTADOS (IoT/Wearables)
// ============================================

// Tipo de dispositivo de saúde
enum HealthDeviceType {
  BLOOD_PRESSURE // Medidor de pressão
  GLUCOMETER // Glicosímetro
  PULSE_OXIMETER // Oxímetro de pulso
  THERMOMETER // Termômetro
  SCALE // Balança
  HEART_RATE // Monitor cardíaco
  ECG // Eletrocardiograma
  STETHOSCOPE // Estetoscópio digital
  OTOSCOPE // Otoscópio digital
  DERMATOSCOPE // Dermatoscópio
  SPIROMETER // Espirômetro
  SLEEP_TRACKER // Monitor de sono
  ACTIVITY_TRACKER // Monitor de atividade
  CGM // Monitor contínuo de glicose
  SMARTWATCH // Relógio inteligente
  FITNESS_BAND // Pulseira fitness
  OTHER // Outro
}

// Fonte de dados do dispositivo
enum DeviceDataSource {
  APPLE_HEALTHKIT // Apple HealthKit (iOS)
  GOOGLE_FIT // Google Fit (Android)
  HEALTH_CONNECT // Health Connect (Android 14+)
  DIRECT_BLUETOOTH // Conexão Bluetooth direta
  DIRECT_WIFI // Conexão WiFi direta
  MANUAL_ENTRY // Entrada manual
  API_INTEGRATION // Integração via API do fabricante
  FHIR // Padrão FHIR
  OPEN_MHEALTH // Padrão Open mHealth
}

// Status de conexão do dispositivo
enum DeviceConnectionStatus {
  CONNECTED // Conectado e sincronizando
  DISCONNECTED // Desconectado
  PAIRING // Em processo de pareamento
  ERROR // Erro de conexão
  NEEDS_AUTH // Precisa reautorização
}

// Dispositivo de saúde conectado
model ConnectedDevice {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Identificação do dispositivo
  deviceType      HealthDeviceType
  deviceName      String // Nome do dispositivo (ex: "Apple Watch Series 9")
  manufacturer    String? // Fabricante (ex: "Apple", "Omron")
  model           String? // Modelo específico
  serialNumber    String? // Número de série
  firmwareVersion String? // Versão do firmware

  // Conexão
  dataSource       DeviceDataSource
  connectionStatus DeviceConnectionStatus @default(DISCONNECTED)
  lastSyncAt       DateTime? // Última sincronização
  syncFrequency    Int? // Frequência de sync em minutos

  // Autenticação (para APIs de fabricantes)
  accessToken    String? // Token de acesso (criptografado)
  refreshToken   String? // Token de refresh (criptografado)
  tokenExpiresAt DateTime? // Expiração do token

  // Configurações
  isActive         Boolean @default(true)
  autoSync         Boolean @default(true)
  notifyOnAbnormal Boolean @default(true) // Alertar valores anormais

  // Metadados
  metadata  Json? // Dados extras específicos do dispositivo
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  readings DeviceReading[]

  @@unique([patientId, serialNumber])
  @@index([patientId])
  @@index([deviceType])
  @@map("connected_devices")
}

// Leitura/medição de um dispositivo
model DeviceReading {
  id        String           @id @default(cuid())
  deviceId  String?
  device    ConnectedDevice? @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  patientId String
  patient   Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Tipo de medição
  readingType ReadingType

  // Valores (usando campos genéricos para flexibilidade)
  primaryValue   Float // Valor principal (ex: glicose, SpO2, peso)
  secondaryValue Float? // Valor secundário (ex: pressão diastólica)
  tertiaryValue  Float? // Valor terciário (se necessário)
  unit           String // Unidade (ex: "mg/dL", "mmHg", "kg")

  // Contexto da medição
  measuredAt DateTime // Quando a medição foi feita
  syncedAt   DateTime @default(now()) // Quando foi sincronizado

  // Metadados da medição
  context  ReadingContext? // Contexto (jejum, pós-refeição, etc)
  notes    String? // Observações
  isManual Boolean         @default(false) // Entrada manual vs automática

  // Qualidade/confiabilidade
  confidence    Float? // Score de confiança (0-1)
  isValid       Boolean @default(true)
  invalidReason String? // Motivo se inválido

  // Alertas
  isAbnormal     Boolean        @default(false)
  alertSeverity  AlertSeverity? // Severidade se anormal
  alertTriggered Boolean        @default(false)

  // Dados brutos do dispositivo
  rawData Json? // Dados originais do dispositivo

  createdAt DateTime @default(now())

  @@index([patientId, readingType])
  @@index([deviceId, measuredAt])
  @@index([measuredAt])
  @@index([isAbnormal])
  @@map("device_readings")
}

// Tipo de leitura/medição
enum ReadingType {
  // Cardiovascular
  BLOOD_PRESSURE_SYSTOLIC // Pressão sistólica
  BLOOD_PRESSURE_DIASTOLIC // Pressão diastólica
  BLOOD_PRESSURE // Pressão (combinado)
  HEART_RATE // Frequência cardíaca
  HEART_RATE_VARIABILITY // Variabilidade cardíaca
  ECG_RHYTHM // Ritmo ECG

  // Respiratório
  OXYGEN_SATURATION // SpO2
  RESPIRATORY_RATE // Frequência respiratória
  PEAK_FLOW // Pico de fluxo
  FEV1 // Volume expiratório forçado

  // Metabólico
  BLOOD_GLUCOSE // Glicemia
  BLOOD_GLUCOSE_FASTING // Glicemia em jejum
  BLOOD_GLUCOSE_POSTMEAL // Glicemia pós-prandial
  KETONES // Cetonas

  // Composição corporal
  WEIGHT // Peso
  BMI // IMC
  BODY_FAT // % gordura corporal
  MUSCLE_MASS // Massa muscular
  BONE_MASS // Massa óssea
  WATER_PERCENTAGE // % água corporal
  VISCERAL_FAT // Gordura visceral

  // Temperatura
  BODY_TEMPERATURE // Temperatura corporal
  SKIN_TEMPERATURE // Temperatura da pele

  // Sono
  SLEEP_DURATION // Duração do sono
  SLEEP_DEEP // Sono profundo
  SLEEP_REM // Sono REM
  SLEEP_LIGHT // Sono leve
  SLEEP_AWAKE // Tempo acordado
  SLEEP_SCORE // Score de qualidade

  // Atividade física
  STEPS // Passos
  DISTANCE // Distância
  CALORIES_BURNED // Calorias queimadas
  ACTIVE_MINUTES // Minutos ativos
  FLOORS_CLIMBED // Andares subidos
  EXERCISE_DURATION // Duração exercício

  // Estresse/Mental
  STRESS_LEVEL // Nível de estresse
  MINDFULNESS_MINUTES // Minutos de mindfulness

  // Áudio/Exame
  HEART_SOUND // Som cardíaco (estetoscópio)
  LUNG_SOUND // Som pulmonar
  EAR_IMAGE // Imagem do ouvido (otoscópio)
  SKIN_IMAGE // Imagem da pele (dermatoscópio)

  // Outros
  HYDRATION // Hidratação
  MENSTRUAL_CYCLE // Ciclo menstrual
  MEDICATION_TAKEN // Medicação tomada
  OTHER // Outro
}

// Contexto da medição
enum ReadingContext {
  FASTING // Em jejum
  BEFORE_MEAL // Antes da refeição
  AFTER_MEAL // Depois da refeição
  BEFORE_EXERCISE // Antes do exercício
  AFTER_EXERCISE // Depois do exercício
  RESTING // Em repouso
  ACTIVE // Em atividade
  SLEEPING // Dormindo
  WAKING // Ao acordar
  BEDTIME // Ao deitar
  STRESSED // Estressado
  RELAXED // Relaxado
  ILL // Doente
  MEDICATED // Após medicação
}

// Severidade de alerta
enum AlertSeverity {
  LOW // Atenção
  MEDIUM // Moderado
  HIGH // Alto
  CRITICAL // Crítico
}

// Limites de referência para alertas
model ReadingThreshold {
  id        String   @id @default(cuid())
  patientId String? // Se null, é padrão global
  patient   Patient? @relation(fields: [patientId], references: [id], onDelete: Cascade)

  readingType ReadingType

  // Limites
  criticalLow  Float? // Abaixo = crítico
  warningLow   Float? // Abaixo = atenção
  normalMin    Float? // Início da faixa normal
  normalMax    Float? // Fim da faixa normal
  warningHigh  Float? // Acima = atenção
  criticalHigh Float? // Acima = crítico

  // Aplicabilidade
  context ReadingContext? // Contexto específico (ex: jejum para glicose)
  ageMin  Int? // Idade mínima
  ageMax  Int? // Idade máxima

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([patientId, readingType, context])
  @@index([readingType])
  @@map("reading_thresholds")
}

// Sessão de sincronização
model DeviceSyncSession {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  dataSource  DeviceDataSource
  startedAt   DateTime         @default(now())
  completedAt DateTime?

  // Estatísticas
  readingsImported Int @default(0)
  readingsSkipped  Int @default(0)
  errors           Int @default(0)

  status       SyncStatus @default(IN_PROGRESS)
  errorMessage String?

  @@index([patientId])
  @@map("device_sync_sessions")
}

enum SyncStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
  PARTIAL
}

// ============================================
// CONSENTIMENTO DE BIOMETRIA (LGPD)
// ============================================

// Tipos de dados biométricos que podem ser compartilhados
enum BiometricDataType {
  HEART_RATE // Frequência cardíaca
  BLOOD_PRESSURE // Pressão arterial
  OXYGEN_SATURATION // Saturação de oxigênio
  BLOOD_GLUCOSE // Glicemia
  BODY_TEMPERATURE // Temperatura
  WEIGHT // Peso
  BODY_COMPOSITION // Composição corporal (gordura, massa muscular)
  STEPS // Passos
  DISTANCE // Distância percorrida
  CALORIES // Calorias
  ACTIVITY // Atividade física
  SLEEP // Dados de sono
  HEART_SOUNDS // Sons cardíacos (estetoscópio)
  RESPIRATORY // Dados respiratórios
  ECG // Eletrocardiograma
  OTHER // Outros
}

// Convite para paciente com opções de consentimento
model PatientInvite {
  id String @id @default(cuid())

  // Dados do convite
  email       String
  phone       String? // Para envio via WhatsApp
  patientName String // Nome do paciente
  token       String       @unique
  expiresAt   DateTime
  status      InviteStatus @default(PENDING)

  // Quem enviou
  invitedById String
  invitedBy   User   @relation(fields: [invitedById], references: [id])

  // Dados pré-preenchidos (opcional)
  birthDate DateTime?
  cpf       String?

  // Mensagem personalizada
  customMessage String?

  // Consentimento aceito
  consentAcceptedAt DateTime?
  consentIpAddress  String? // IP do aceite (auditoria)
  consentUserAgent  String? // Navegador usado (auditoria)

  // Relação com consentimentos
  biometricConsents PatientBiometricConsent[]

  // Paciente criado (após aceite)
  patientId String?  @unique
  patient   Patient? @relation(fields: [patientId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([token])
  @@map("patient_invites")
}

// Consentimento individual para cada tipo de dado biométrico
model PatientBiometricConsent {
  id String @id @default(cuid())

  // Relacionamentos
  patientId String?
  patient   Patient?       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  inviteId  String?
  invite    PatientInvite? @relation(fields: [inviteId], references: [id], onDelete: Cascade)

  // Tipo de dado
  dataType BiometricDataType

  // Consentimento
  isGranted Boolean   @default(false)
  grantedAt DateTime?
  revokedAt DateTime?

  // Finalidade explicada ao paciente
  purpose String // "Monitoramento de pressão arterial para acompanhamento de hipertensão"

  // Auditoria
  ipAddress String?
  userAgent String?

  // Validade (opcional - para consentimentos temporários)
  validUntil DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([patientId, dataType])
  @@index([patientId])
  @@index([inviteId])
  @@map("patient_biometric_consents")
}

// Histórico de alterações de consentimento (auditoria LGPD)
model ConsentAuditLog {
  id String @id @default(cuid())

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  dataType      BiometricDataType
  action        ConsentAction // GRANTED, REVOKED, MODIFIED
  previousValue Boolean?
  newValue      Boolean

  // Auditoria
  ipAddress String?
  userAgent String?
  reason    String? // Motivo da alteração (opcional)

  createdAt DateTime @default(now())

  @@index([patientId])
  @@map("consent_audit_logs")
}

enum ConsentAction {
  GRANTED
  REVOKED
  MODIFIED
}

// ==========================================
// QUESTIONÁRIOS INTEGRATIVOS
// ==========================================

// Tipos de sistema terapêutico
enum TherapeuticSystem {
  AYURVEDA
  HOMEOPATHY
  TCM // Traditional Chinese Medicine
  ANTHROPOSOPHY
  NATUROPATHY
  FUNCTIONAL
  GENERAL
  CUSTOM
}

// Tipos de pergunta (questionários integrativos)
enum IntakeQuestionType {
  SINGLE_CHOICE // Uma opção
  MULTIPLE_CHOICE // Múltiplas opções
  SCALE // Escala numérica (1-10, etc)
  TEXT // Texto livre
  IMAGE_CHOICE // Escolha com imagens
  YES_NO // Sim/Não
  BODY_MAP // Mapa corporal (clique em região)
}

// Status do questionário enviado
enum QuestionnaireStatus {
  PENDING // Enviado, aguardando
  IN_PROGRESS // Paciente começou
  COMPLETED // Finalizado
  EXPIRED // Expirou sem resposta
  CANCELLED // Cancelado
}

// Template de questionário (criado pelo profissional)
model QuestionnaireTemplate {
  id String @id @default(cuid())

  // Metadados
  name              String // "Avaliação de Prakriti - Ayurveda"
  description       String? // Descrição para o profissional
  patientIntro      String? // Texto de introdução para o paciente
  therapeuticSystem TherapeuticSystem @default(GENERAL)

  // Organização
  categories IntakeCategory[]

  // Configurações
  estimatedMinutes   Int     @default(15)
  allowPause         Boolean @default(true) // Paciente pode pausar
  showProgress       Boolean @default(true) // Mostrar barra de progresso
  randomizeQuestions Boolean @default(false) // Aleatorizar ordem

  // Estilo visual
  themeColor String? // Cor tema (#hex)
  iconEmoji  String? // Emoji do questionário 🌿

  // Template público ou privado
  isPublic  Boolean @default(false) // Disponível para outros profissionais
  isBuiltIn Boolean @default(false) // Template do sistema

  // Criador
  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])

  // Questionários enviados baseados neste template
  sentQuestionnaires PatientQuestionnaire[]

  // Análise IA
  aiAnalysisPrompt String? // Prompt customizado para análise IA
  scoringLogic     Json? // Lógica de pontuação (doshas, temperamentos)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("questionnaire_templates")
}

// Categoria/Seção dentro do questionário
model IntakeCategory {
  id String @id @default(cuid())

  templateId String
  template   QuestionnaireTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  name        String // "Características Físicas"
  description String? // Breve explicação
  order       Int     @default(0)
  iconEmoji   String? // 🏃 para seção física

  questions IntakeQuestion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
  @@map("intake_categories")
}

// Pergunta individual
model IntakeQuestion {
  id String @id @default(cuid())

  categoryId String
  category   IntakeCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  // Conteúdo
  text     String // "Como é sua digestão habitualmente?"
  helpText String? // Texto de ajuda/explicação
  imageUrl String? // Imagem ilustrativa

  // Tipo e configuração
  type       IntakeQuestionType @default(SINGLE_CHOICE)
  isRequired Boolean            @default(true)
  order      Int                @default(0)

  // Para escala
  scaleMin      Int? // Ex: 1
  scaleMax      Int? // Ex: 10
  scaleMinLabel String? // "Muito lenta"
  scaleMaxLabel String? // "Muito rápida"

  // Opções de resposta
  options IntakeQuestionOption[]

  // Respostas dos pacientes
  answers PatientAnswer[]

  // Mapeamento para análise (ex: dosha, temperamento)
  analysisMapping Json? // { "vata": 0, "pitta": 2, "kapha": 1 }

  // Lógica condicional (mostrar só se...)
  conditionalLogic Json? // { "showIf": { "questionId": "xxx", "value": "sim" } }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@map("intake_questions")
}

// Opção de resposta (para choice questions)
model IntakeQuestionOption {
  id String @id @default(cuid())

  questionId String
  question   IntakeQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  text        String // "Rápida e irregular"
  description String? // Explicação adicional
  imageUrl    String? // Imagem/ícone
  emoji       String? // 🔥
  order       Int     @default(0)

  // Pontuação para análise
  scoreValue Json? // { "vata": 2, "pitta": 0, "kapha": 0 }

  // Respostas que selecionaram esta opção
  selectedIn PatientAnswer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([questionId])
  @@map("intake_question_options")
}

// Questionário enviado para um paciente específico
model PatientQuestionnaire {
  id String @id @default(cuid())

  // Template usado
  templateId String
  template   QuestionnaireTemplate @relation(fields: [templateId], references: [id])

  // Paciente
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Profissional que enviou
  sentById String
  sentBy   User   @relation("SentQuestionnaires", fields: [sentById], references: [id])

  // Status
  status QuestionnaireStatus @default(PENDING)

  // Token para acesso (link público)
  accessToken String @unique @default(cuid())

  // Datas
  sentAt      DateTime  @default(now())
  startedAt   DateTime? // Quando começou a responder
  completedAt DateTime? // Quando finalizou
  expiresAt   DateTime? // Data limite

  // Progresso
  lastQuestionId  String? // Última pergunta respondida (para retomar)
  progressPercent Int     @default(0)

  // Respostas
  answers PatientAnswer[]

  // Análise IA
  aiAnalysis   Json? // Resultado da análise automática
  aiAnalyzedAt DateTime?

  // Notas do profissional
  professionalNotes String?

  // Associar a uma consulta (opcional)
  consultationId String?
  consultation   Consultation? @relation(fields: [consultationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([templateId])
  @@index([accessToken])
  @@map("patient_questionnaires")
}

// Resposta individual do paciente
model PatientAnswer {
  id String @id @default(cuid())

  questionnaireId String
  questionnaire   PatientQuestionnaire @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)

  questionId String
  question   IntakeQuestion @relation(fields: [questionId], references: [id])

  // Resposta (dependendo do tipo)
  textValue    String? // Para TEXT
  numericValue Float? // Para SCALE
  booleanValue Boolean? // Para YES_NO

  // Para SINGLE/MULTIPLE_CHOICE
  selectedOptionId String?
  selectedOption   IntakeQuestionOption? @relation(fields: [selectedOptionId], references: [id])

  // Para MULTIPLE_CHOICE (múltiplas seleções)
  selectedOptionIds String[] // Array de IDs

  // Para BODY_MAP
  bodyMapData Json? // { "region": "head", "x": 50, "y": 30, "note": "dor" }

  // Metadados
  answeredAt       DateTime @default(now())
  timeSpentSeconds Int? // Tempo gasto na pergunta

  @@unique([questionnaireId, questionId])
  @@index([questionnaireId])
  @@map("patient_answers")
}

// =====================================
// EQUIPE DE CUIDADO DO PACIENTE
// =====================================
// Níveis de acesso: FULL, CONSULTATION, LIMITED, EMERGENCY, VIEW_ONLY

// Relaciona pacientes aos profissionais que podem acessá-los
model PatientCareTeam {
  id String @id @default(cuid())

  // Paciente
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Profissional da equipe
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Nível de acesso: FULL, CONSULTATION, LIMITED, EMERGENCY, VIEW_ONLY
  accessLevel String @default("CONSULTATION")

  // Quem adicionou à equipe
  addedById String?

  // Motivo/observação
  reason String? // Ex: "Consulta agendada", "Médico de família"

  // Controle
  isActive  Boolean @default(true)
  isPrimary Boolean @default(false)

  // Validade do acesso (null = permanente)
  validUntil DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([patientId, userId])
  @@index([patientId])
  @@index([userId])
  @@index([isActive])
  @@map("patient_care_team")
}

// ========================================
// FILA DE ESPERA (WAITING LIST)
// ========================================

model WaitingList {
  id String @id @default(cuid())

  // Paciente
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Médico/Especialidade desejada
  doctorId  String? // Médico específico (opcional)
  doctor    User?   @relation(fields: [doctorId], references: [id])
  specialty String? // Especialidade genérica

  // Preferências de horário
  preferredDays  String[] // ["MON", "WED", "FRI"]
  preferredTimes String[] // ["MORNING", "AFTERNOON", "EVENING"]

  // Prioridade (1-10, quanto maior mais urgente)
  priority      Int     @default(5)
  urgencyReason String? // Motivo da urgência

  // Status
  status WaitingListStatus @default(ACTIVE)

  // Notificações enviadas
  notificationsSent Int       @default(0)
  lastNotifiedAt    DateTime?

  // Quando foi atendido
  appointmentId String?       @unique
  appointment   Consultation? @relation(fields: [appointmentId], references: [id])

  // Observações
  notes String?

  // Controle
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime? // Data limite para atendimento

  @@index([patientId])
  @@index([doctorId])
  @@index([status])
  @@index([priority])
  @@map("waiting_lists")
}

enum WaitingListStatus {
  ACTIVE // Aguardando vaga
  NOTIFIED // Paciente foi notificado de vaga disponível
  SCHEDULED // Consulta agendada
  EXPIRED // Prazo expirou
  CANCELLED // Paciente cancelou
}

// =====================================
// TELEMEDICINE RECORDINGS
// =====================================

enum RecordingStatus {
  RECORDING
  COMPLETED
  FAILED
  CANCELLED
  DELETED
}

model TelemedicineRecording {
  id String @id @default(cuid())

  // Relacionamentos
  consultationId String
  consultation   Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   User   @relation("DoctorRecordings", fields: [doctorId], references: [id])

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Dados da gravação
  status    RecordingStatus @default(RECORDING)
  startedAt DateTime        @default(now())
  endedAt   DateTime?
  duration  Int? // Duração em segundos

  // Arquivo
  filePath String?
  fileName String?
  fileSize Int? // Tamanho em bytes
  fileHash String? // SHA-256 para integridade
  format   String  @default("webm")

  // LGPD - Consentimento
  patientConsent   Boolean   @default(false)
  consentTimestamp DateTime?

  // Soft delete
  deletedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  accessTokens RecordingAccessToken[]

  @@index([consultationId])
  @@index([doctorId])
  @@index([patientId])
  @@index([status])
  @@index([createdAt])
}

model RecordingAccessToken {
  id String @id @default(cuid())

  recordingId String
  recording   TelemedicineRecording @relation(fields: [recordingId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  token     String   @unique
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([recordingId])
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// =====================================
// MEDICAL CERTIFICATES (ATESTADOS)
// =====================================

enum CertificateType {
  MEDICAL_LEAVE // Atestado de afastamento (Afastamento)
  FITNESS // Atestado de aptidão física
  ACCOMPANIMENT // Atestado de acompanhante (Comparecimento)
  TIME_OFF // Atestado de comparecimento simples
  CUSTOM // Atestado personalizado

  // ============================================
  // SSF LEGACY CERTIFICATE TYPES
  // ============================================
  SHIFT_LEAVE // Atestado de Turno
  MUNICIPAL_TRANSPORT // Passe Livre Municipal
  INTERSTATE_TRANSPORT // Passe Livre Intermunicipal
  MEDICAL_EVALUATION // Perícia Médica
  MATERNITY_LEAVE // Licença Maternidade
  ADDITIONAL // Atestado Adicional
  PERIODIC_EXAM // Exame Periódico
  DISMISSAL_EXAM // Exame Demissional
  HEALTH_CERTIFICATE // Atestado de Saúde
  // ============================================
}

model MedicalCertificate {
  id String @id @default(cuid())

  // Numeração sequencial obrigatória
  sequenceNumber Int @unique
  year           Int // Ano da emissão (para reiniciar numeração)

  // Relacionamentos
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  doctorId String
  doctor   User   @relation("DoctorCertificates", fields: [doctorId], references: [id])

  consultationId String?
  consultation   Consultation? @relation(fields: [consultationId], references: [id])

  // Dados do atestado
  type      CertificateType @default(MEDICAL_LEAVE)
  days      Int? // Dias de afastamento (null se não aplicável)
  startDate DateTime // Data inicial do afastamento/validade
  endDate   DateTime? // Data final (calculada: startDate + days)

  // CID-10 (opcional - não obrigatório em atestados)
  includeCid     Boolean @default(false)
  cidCode        String?
  cidDescription String?

  // Texto do atestado
  title        String  @default("ATESTADO MÉDICO")
  content      String // Texto livre do atestado
  observations String? // Observações adicionais

  // PDF e assinatura
  pdfPath    String? // Caminho do PDF gerado
  pdfHash    String? // Hash SHA-256 do PDF
  qrCodeData String? // Dados do QR Code para validação

  // Assinatura digital - PKI Local (auto-assinado)
  signature        String?  // Base64 da assinatura (SHA-256 + RSA)
  signatureMethod  String   @default("NONE")  // NONE, PKI_LOCAL, ICP_BRASIL
  
  // Assinatura digital - ICP-Brasil (futuro)
  digitalSignature String? // Base64 da assinatura digital ICP-Brasil
  certificateChain String? // Cadeia de certificados
  timestamp        DateTime? // Timestamp da assinatura

  // Controle
  issuedAt      DateTime  @default(now())
  revokedAt     DateTime?
  revokedReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([doctorId])
  @@index([consultationId])
  @@index([sequenceNumber, year])
  @@index([issuedAt])
}

// =====================================
// EXTERNAL SYSTEM INTEGRATIONS
// =====================================

model IntegrationLog {
  id String @id @default(cuid())

  // Integration identifier
  integrationName String // CARTORIO, SUS, GOVERNMENT_PROTOCOL
  
  // Related certificate
  certificateId String
  
  // Submission status
  status String // SUBMITTED, PROCESSING, APPROVED, REJECTED, ERROR
  
  // Request and response data
  requestPayload  String // JSON payload sent to external system
  responseData    String // Response from external system or error details
  
  // Protocol/Reference numbers from external systems
  externalProtocolId String? // e.g., Cartório protocol, SUS record ID, etc.
  externalReference  String? // Additional reference from external system
  
  // Tracking
  submittedAt DateTime @default(now())
  lastCheckedAt DateTime?
  resolvedAt DateTime?
  
  // Error tracking
  errorCount Int @default(0)
  lastError String?
  
  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([certificateId])
  @@index([integrationName])
  @@index([status])
  @@index([submittedAt])
}

// =====================================
// NPS (NET PROMOTER SCORE)
// =====================================

enum NpsScore {
  DETRACTOR // 0-6
  PASSIVE // 7-8
  PROMOTER // 9-10
}

model NpsResponse {
  id String @id @default(cuid())

  // Relacionamentos
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  consultationId String       @unique
  consultation   Consultation @relation(fields: [consultationId], references: [id])

  doctorId String
  doctor   User   @relation("DoctorNpsResponses", fields: [doctorId], references: [id])

  // Score NPS (0-10)
  score    Int // 0-10
  category NpsScore // Calculado automaticamente

  // Feedback
  feedback       String? // Comentário opcional
  wouldRecommend Boolean @default(true)

  // Categorização de feedback
  tags      String[] @default([]) // Ex: ["atendimento", "tempo_espera", "limpeza"]
  sentiment String? // POSITIVE, NEUTRAL, NEGATIVE (análise de IA)

  // Controle
  sentAt      DateTime? // Quando foi enviada a pesquisa
  respondedAt DateTime  @default(now())

  // WhatsApp integration
  sentViaWhatsApp   Boolean @default(false)
  whatsAppMessageId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([doctorId])
  @@index([consultationId])
  @@index([score])
  @@index([category])
  @@index([respondedAt])
}

// Assinatura Digital (ICP-Brasil)
model DigitalCertificate {
  id     String @id @default(cuid())
  userId String
  user   User   @relation("UserDigitalCertificates", fields: [userId], references: [id], onDelete: Cascade)

  // Dados do certificado
  certificateType CertificateAuthority // A1, A3, A4
  issuer          String // Autoridade Certificadora (ex: Serasa, Certisign)
  subject         String // CN do certificado
  serialNumber    String               @unique
  notBefore       DateTime // Início da validade
  notAfter        DateTime // Fim da validade

  // Armazenamento
  certificatePem String @db.Text // Certificado em formato PEM
  publicKeyPem   String @db.Text // Chave pública
  
  // A1: Arquivo .pfx criptografado (apenas para A1)
  pfxFilePath    String? // Caminho do arquivo .pfx no servidor
  pfxPasswordHash String? // Hash da senha (para validação)

  // A3/A4: Token físico (não armazenar chave privada)
  isHardwareToken   Boolean @default(false)
  tokenSerialNumber String? // Identificador do token A3

  // Status
  isActive      Boolean   @default(true)
  revokedAt     DateTime?
  revokedReason String?

  // Uso
  lastUsedAt DateTime?
  usageCount Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  signedDocuments SignedDocument[]

  @@index([userId])
  @@index([notAfter])
  @@index([isActive])
}

// Documento assinado digitalmente
model SignedDocument {
  id String @id @default(cuid())

  // Tipo de documento
  documentType SignedDocumentType
  documentId   String // ID do prontuário, atestado, prescrição, etc.

  // Assinatura
  certificateId String
  certificate   DigitalCertificate @relation(fields: [certificateId], references: [id])
  signerId      String // userId do assinante
  signer        User               @relation("UserSignedDocuments", fields: [signerId], references: [id])

  // Dados da assinatura
  signatureAlgorithm String // SHA256withRSA, etc.
  signatureValue     String @db.Text // Base64 da assinatura
  signatureHash      String // Hash SHA-256 do documento original

  // Timestamp (carimbo de tempo)
  timestampAuthority String? // URL da TSA (Time Stamping Authority)
  timestampToken     String?   @db.Text // Token de tempo RFC 3161
  timestampedAt      DateTime?

  // Metadados
  ipAddress   String?
  userAgent   String?
  geolocation String? // Lat,Long (opcional)

  // Validação
  isValid          Boolean   @default(true)
  validatedAt      DateTime?
  validationResult String?   @db.Text // Resultado da última validação

  // Auditoria
  signedAt  DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([documentType, documentId])
  @@index([signerId])
  @@index([certificateId])
  @@index([signedAt])
}

enum CertificateAuthority {
  A1 // Chave privada armazenada em software (1 ano)
  A3 // Chave privada em token/smartcard (3 anos)
  A4 // Chave privada em token/smartcard (3 anos, alta segurança)
}

enum SignedDocumentType {
  MEDICAL_RECORD // Prontuário
  MEDICAL_CERTIFICATE // Atestado médico
  PRESCRIPTION // Prescrição/receita
  EXAM_REQUEST // Solicitação de exame
  EXAM_RESULT // Resultado de exame
  REFERRAL // Encaminhamento
  CONSENT_FORM // Termo de consentimento
  TELECONSULTATION // Relatório de teleconsulta
  DISCHARGE_SUMMARY // Sumário de alta
}

// Alerta de auditoria (anomalias, tentativas de acesso, etc.)
model AuditAlert {
  id String @id @default(cuid())

  // Tipo de alerta
  alertType AuditAlertType
  severity  AlertSeverity  @default(MEDIUM)

  // Detalhes
  title       String
  description String @db.Text

  // Origem
  userId       String?
  ipAddress    String?
  resourceType String?
  resourceId   String?

  // Evidências
  auditLogIds String[] // Array de IDs de AuditLog relacionados
  metadata    Json? // Dados adicionais

  // Status
  status          AlertStatus @default(OPEN)
  assignedTo      String? // Admin/Manager responsável
  resolvedBy      String?
  resolvedAt      DateTime?
  resolutionNotes String?     @db.Text

  // Notificação
  notifiedAt  DateTime?
  notifiedVia String? // email, slack, sms

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([alertType])
  @@index([severity])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
}

enum AuditAlertType {
  FAILED_LOGIN_ATTEMPTS // Múltiplas tentativas de login falhadas
  UNAUTHORIZED_ACCESS // Acesso a recurso sem permissão
  DATA_EXPORT_BULK // Exportação em massa de dados
  ROLE_PRIVILEGE_ESCALATION // Tentativa de elevar privilégios
  AFTER_HOURS_ACCESS // Acesso fora do horário
  UNUSUAL_ACTIVITY_PATTERN // Padrão anômalo de acesso
  SENSITIVE_DATA_ACCESS // Acesso a dados sensíveis (HIV, psiquiatria)
  GDPR_DATA_DELETION // Solicitação LGPD de exclusão
  FAILED_AUDIT_VALIDATION // Inconsistências em auditoria
  CRITICAL_ERROR // Erro crítico do sistema
}

enum AlertStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  FALSE_POSITIVE
  IGNORED
}

// ============================================================================
// WELLNESS DASHBOARD - Patient Experience Models
// ============================================================================

model PatientMoodLog {
  id        String   @id @default(cuid())
  patientId String
  mood      Int      @db.SmallInt // 1-5 (😢😐🙂😊🤗)
  energy    Int      @db.SmallInt // 1-5
  stress    Int      @db.SmallInt // 1-5
  sleep     Int      @db.SmallInt // 1-5
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient Patient @relation("PatientMoodLogs", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, createdAt])
  @@map("patient_mood_logs")
}

model PatientAptitude {
  id           String   @id @default(cuid())
  patientId    String
  name         String // "Coração Estável", "Ativo e Dedicado"
  description  String   @db.Text
  icon         String // "heart", "flame", "target"
  category     String // "health", "behavior", "emotional"
  score        Float    @default(0) // 0-100
  discoveredAt DateTime @default(now())
  updatedAt    DateTime @updatedAt

  patient Patient @relation("PatientAptitudes", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, category])
  @@index([patientId, score])
  @@map("patient_aptitudes")
}

model PatientBadge {
  id          String      @id @default(cuid())
  patientId   String
  name        String // "Iniciante", "Comprometido", "Épico"
  rarity      BadgeRarity @default(COMMON)
  icon        String // "sprout", "star", "trophy"
  description String?     @db.Text
  progress    Float       @default(0) // 0-100
  unlockedAt  DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  patient Patient @relation("PatientBadges", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, rarity])
  @@index([patientId, unlockedAt])
  @@map("patient_badges")
}

model PatientDevelopmentPlan {
  id           String             @id @default(cuid())
  patientId    String
  title        String // "Seu plano de 90 dias"
  description  String             @db.Text
  startDate    DateTime
  targetDate   DateTime
  phases       Json // Array de fases com metas
  currentPhase Int                @default(1)
  progress     Float              @default(0) // 0-100
  status       WellnessPlanStatus @default(ACTIVE)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  patient Patient @relation("PatientWellnessDevelopmentPlans", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, status])
  @@index([patientId, targetDate])
  @@map("patient_development_plans")
}

model PatientHealthEvent {
  id             String    @id @default(cuid())
  patientId      String
  title          String
  description    String    @db.Text
  type           EventType // "medication", "consultation", "exam", "vital", "milestone"
  eventDate      DateTime
  impact         String? // "PA melhorou 12%", "Nova aptitude descoberta"
  causalite      String?   @db.Text // Linkage: "Desde medicação ajustada..."
  vitalsSnapshot Json? // Snapshot de dados na hora do evento
  metadata       Json? // Dados adicionais
  createdAt      DateTime  @default(now())

  patient Patient @relation("PatientHealthEvents", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, eventDate])
  @@index([patientId, type])
  @@map("patient_health_events")
}

model PatientWellnessScore {
  id                 String   @id @default(cuid())
  patientId          String
  score              Float // 0-100
  moodComponent      Float // % do score vindo do mood
  adherenceComponent Float // % do score vindo da adesão
  vitalComponent     Float // % do score vindo dos vitais
  emotionalComponent Float // % do score vindo do emocional
  calculatedAt       DateTime @default(now())

  patient Patient @relation("PatientWellnessScores", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, calculatedAt])
  @@map("patient_wellness_scores")
}

model PatientJournal {
  id           String   @id @default(cuid())
  patientId    String
  weekStarting DateTime // Data do início da semana
  reflection   String   @db.Text
  insights     String?  @db.Text
  goals        Json? // Array de metas para próxima semana
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  patient Patient @relation("PatientJournals", fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, weekStarting])
  @@map("patient_journals")
}

// Enums para Wellness Dashboard

enum BadgeRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

enum WellnessPlanStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum EventType {
  MEDICATION
  CONSULTATION
  EXAM
  VITAL
  MILESTONE
  APPOINTMENT
  DIAGNOSIS
  TREATMENT
}

// ============================================
// GEOGRAPHIC HIERARCHY MODELS (SSF Integration)
// Hierarquia: Country → State → City → Zone → District → Subprefecture → Neighborhood → Area → MicroArea
// ============================================

model Country {
  id        String    @id @default(cuid())
  code      String    @unique // ISO 3166-1 alpha-2 (BR)
  name      String    @unique
  states    State[]
  addresses Address[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("countries")
}

model State {
  id     String  @id @default(cuid())
  code   String  @unique // UF code (SP, RJ, MG, etc)
  name   String  @unique
  region String? // Região (Sul, Sudeste, Nordeste, etc)

  countryId String  @default("br") // FK to Country (always Brazil for now)
  country   Country @relation(fields: [countryId], references: [code], onDelete: Cascade)

  cities    City[]
  addresses Address[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([countryId])
  @@map("states")
}

model City {
  id       String @id @default(cuid())
  ibgeCode String @unique // IBGE 7-digit code
  name     String

  stateId String
  state   State  @relation(fields: [stateId], references: [id], onDelete: Cascade)

  zones       Zone[]
  addresses   Address[]
  healthUnits HealthUnit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([stateId, name])
  @@index([stateId])
  @@index([ibgeCode])
  @@map("cities")
}

model Zone {
  id   String  @id @default(cuid())
  code String? // Optional external code
  name String

  cityId String
  city   City   @relation(fields: [cityId], references: [id], onDelete: Cascade)

  districts District[]
  addresses Address[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cityId, name])
  @@index([cityId])
  @@map("zones")
}

model District {
  id   String  @id @default(cuid())
  code String?
  name String

  zoneId String
  zone   Zone   @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  subprefectures Subprefecture[]
  addresses      Address[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([zoneId, name])
  @@index([zoneId])
  @@map("districts")
}

model Subprefecture {
  id   String  @id @default(cuid())
  code String?
  name String

  districtId String
  district   District @relation(fields: [districtId], references: [id], onDelete: Cascade)

  neighborhoods Neighborhood[]
  addresses     Address[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([districtId, name])
  @@index([districtId])
  @@map("subprefectures")
}

model Neighborhood {
  id   String  @id @default(cuid())
  code String?
  name String

  subprefectureId String
  subprefecture   Subprefecture @relation(fields: [subprefectureId], references: [id], onDelete: Cascade)

  areas     Area[]
  addresses Address[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([subprefectureId, name])
  @@index([subprefectureId])
  @@map("neighborhoods")
}

model Area {
  id          String  @id @default(cuid())
  code        String?
  name        String
  description String?

  neighborhoodId String
  neighborhood   Neighborhood @relation(fields: [neighborhoodId], references: [id], onDelete: Cascade)

  microAreas MicroArea[]
  addresses  Address[]
  acsUsers   User[]       @relation("AssignedArea")
  acsHistory ACSHistory[]
  households Household[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([neighborhoodId, name])
  @@index([neighborhoodId])
  @@map("areas")
}

// ACS (Agente Comunitário de Saúde) Management
model ACSHistory {
  id String @id @default(cuid())

  userId String
  user   User   @relation("ACSHistoryEntries", fields: [userId], references: [id], onDelete: Cascade)

  microAreaId String?
  microArea   MicroArea? @relation("ACSHistory", fields: [microAreaId], references: [id], onDelete: SetNull)

  areaId String?
  area   Area?   @relation(fields: [areaId], references: [id], onDelete: SetNull)

  assignedAt       DateTime  @default(now())
  unassignedAt     DateTime?
  assignmentReason String?
  assignedByUserId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, assignedAt])
  @@index([microAreaId])
  @@index([areaId])
  @@map("acs_history")
}

// ============================================
// END GEOGRAPHIC HIERARCHY MODELS
// ============================================

model MedicationTaking {
  id String @id @default(cuid())

  // Relacionamento com item de prescrição
  prescriptionItemId String
  prescriptionItem   PrescriptionItem @relation(fields: [prescriptionItemId], references: [id], onDelete: Cascade)

  // Dados da tomada
  takenAt DateTime // Quando foi tomado
  dosage  String // Dosagem confirmada
  missed  Boolean  @default(false) // Se foi perdido/esquecido
  notes   String? // Notas do paciente

  // Controle
  recordedBy String // ID do usuário que registrou
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([prescriptionItemId])
  @@index([takenAt])
  @@map("medication_takings")
}

// ============================================
// HEALTH UNIT / ESTABELECIMENTO DE SAÚDE
// ============================================

model HealthUnit {
  id String @id @default(cuid())

  // Identificação
  name String
  type String // "UBS", "USF", "UPA", "HOSPITAL", "CLINICA", "LABORATORIO", "FARMACIA"

  // CNES - Cadastro Nacional de Estabelecimentos de Saúde
  cnesCode String? @unique

  // Endereço
  address String?
  cityId  String?
  city    City?   @relation(fields: [cityId], references: [id])

  // Localização
  latitude  Float?
  longitude Float?

  // Contato
  phone   String?
  email   String?
  manager String? // Gestor

  // Operacional
  isActive   Boolean @default(true)
  staffCount Int     @default(0)
  beds       Int? // Para hospitais

  // Relatórios
  dailyReports           DailyProductionReport[]
  monthlyReports         MonthlyProductionReport[]
  stratifiedReports      StratifiedProductionReport[]
  healthSituationReports HealthSituationReport[]
  pregnancyReports       PregnancyReport[]
  pediatricReports       PediatricHealthReport[]
  epidemiologyReports    EpidemiologyReport[]

  // ============================================
  // SSF INTEGRATION - New Relations
  // ============================================
  // Vaccination
  vaccinations Vaccination[] @relation("VaccinationHealthUnit")

  // Referrals
  destinationReferrals Referral[] @relation("ReferralDestinationUnit")
  // ============================================

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cnesCode])
  @@index([cityId])
  @@index([isActive])
  @@map("health_units")
}

// ============================================
// SUS/SIAB PRODUCTION REPORTS
// ============================================

// Produção Diária (SIAB-AD)
model DailyProductionReport {
  id String @id @default(cuid())

  // Período
  reportDate DateTime // Data do relatório
  month      Int
  year       Int

  // Unidade
  healthUnitId String
  healthUnit   HealthUnit @relation(fields: [healthUnitId], references: [id])

  // Profissional
  professionalId String?
  professional   User?   @relation("DailyProductionReportProfessional", fields: [professionalId], references: [id])

  // Consultas por tipo
  clinicConsultations    Int @default(0)
  preNatalConsultations  Int @default(0)
  pediatricConsultations Int @default(0)
  urgencyConsultations   Int @default(0)
  homeVisits             Int @default(0)
  groupActivities        Int @default(0)

  // Total
  totalConsultations Int @default(0)

  // Equipe
  acsActive       Int @default(0)
  acsVisits       Int @default(0)
  familiesVisited Int @default(0)

  // Qualidade
  flagged Boolean @default(false)
  notes   String?

  // Auditoria
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([healthUnitId, reportDate, professionalId])
  @@index([healthUnitId])
  @@index([reportDate])
  @@index([month, year])
  @@index([professionalId])
  @@map("daily_production_reports")
}

// Produção Mensal (SIAB-PM)
model MonthlyProductionReport {
  id String @id @default(cuid())

  // Período
  month Int
  year  Int

  // Unidade
  healthUnitId String
  healthUnit   HealthUnit @relation(fields: [healthUnitId], references: [id])

  // Agregação geral
  totalConsultations Int @default(0)
  totalPatients      Int @default(0)
  newPatients        Int @default(0)
  totalFamilies      Int @default(0)
  populationCovered  Int @default(0)

  // Consultas por tipo
  clinicConsultations    Int @default(0)
  preNatalConsultations  Int @default(0)
  pediatricConsultations Int @default(0)
  urgencyConsultations   Int @default(0)

  // Por faixa etária
  consultationsUnder1 Int @default(0)
  consultations1to4   Int @default(0)
  consultations5to9   Int @default(0)
  consultations10to14 Int @default(0)
  consultations15to19 Int @default(0)
  consultations20to49 Int @default(0)
  consultations50to59 Int @default(0)
  consultations60plus Int @default(0)

  // Equipe
  acsCount        Int @default(0)
  familiesVisited Int @default(0)
  homeVisits      Int @default(0)

  // Indicadores
  coveragePercentage  Float @default(0)
  vaccinationCoverage Float @default(0)
  preNatalCoverage    Float @default(0)
  pediatricCoverage   Float @default(0)

  // Referências
  referralsIssued          Int @default(0)
  counterReferralsReceived Int @default(0)

  // Status
  validated   Boolean   @default(false)
  submittedAt DateTime?

  // Auditoria
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([healthUnitId, month, year])
  @@index([healthUnitId])
  @@index([month, year])
  @@index([validated])
  @@map("monthly_production_reports")
}

// Produção Estratificada (SIAB-PE)
model StratifiedProductionReport {
  id String @id @default(cuid())

  // Período
  month Int
  year  Int

  // Unidade
  healthUnitId String
  healthUnit   HealthUnit @relation(fields: [healthUnitId], references: [id])

  // Dimensões de estratificação
  ageGroup String // "under1", "1to4", "5to9", etc
  gender   String? // "M", "F", "O"
  type     String // "clinic", "prenatal", "pediatric", "urgency"

  // Dados estratificados
  consultationCount Int @default(0)
  patientCount      Int @default(0)
  newPatients       Int @default(0)

  // Indicadores específicos
  vaccinated    Int @default(0)
  referrals     Int @default(0)
  complications Int @default(0)

  // Auditoria
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([healthUnitId, month, year, ageGroup, gender, type])
  @@index([healthUnitId])
  @@index([month, year])
  @@index([ageGroup])
  @@index([type])
  @@map("stratified_production_reports")
}

// Relatório de Situação de Saúde (SIAB-SS)
model HealthSituationReport {
  id String @id @default(cuid())

  // Período
  month Int
  year  Int

  // Unidade
  healthUnitId String
  healthUnit   HealthUnit @relation(fields: [healthUnitId], references: [id])

  // Doenças/Condições (Agregadas)
  diabeticCases         Int @default(0)
  hypertensiveCases     Int @default(0)
  tuberculosisCases     Int @default(0)
  leprousCases          Int @default(0)
  hivCases              Int @default(0)
  syphilisCases         Int @default(0)
  pregnantWomen         Int @default(0)
  malnourishedChildren  Int @default(0)
  domesticViolenceCases Int @default(0)
  substanceAbuseCases   Int @default(0)

  // Indicadores
  followedDiabetics    Int @default(0)
  followedHypertensive Int @default(0)
  followedTuberculosis Int @default(0)

  // Status de saúde crítico
  criticalRiskCases  Int @default(0)
  medicalEmergencies Int @default(0)
  hospitalizations   Int @default(0)
  deaths             Int @default(0)

  // Auditoria
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([healthUnitId, month, year])
  @@index([healthUnitId])
  @@index([month, year])
  @@map("health_situation_reports")
}

// Relatório de Gestantes (SIAB-AG)
model PregnancyReport {
  id String @id @default(cuid())

  // Período
  month Int
  year  Int

  // Unidade
  healthUnitId String
  healthUnit   HealthUnit @relation(fields: [healthUnitId], references: [id])

  // Gestantes
  enrolledPregnancies Int @default(0)
  activeFollowUps     Int @default(0)

  // Acompanhamento
  preNatalConsultations Int @default(0)
  bloodPressureChecks   Int @default(0)
  urineTests            Int @default(0)
  bloodTests            Int @default(0)

  // Imunização
  tetanusCoverage   Int @default(0)
  influenzaCoverage Int @default(0)

  // Complicações
  gestationalDiabetes Int @default(0)
  preeclampsia        Int @default(0)
  highRiskCases       Int @default(0)
  referrals           Int @default(0)

  // Desfecho
  livebirths     Int @default(0)
  stillbirths    Int @default(0)
  maternalDeaths Int @default(0)

  // Auditoria
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([healthUnitId, month, year])
  @@index([healthUnitId])
  @@index([month, year])
  @@map("pregnancy_reports")
}

// Relatório de Crianças (SIAB-AC)
model PediatricHealthReport {
  id String @id @default(cuid())

  // Período
  month Int
  year  Int

  // Unidade
  healthUnitId String
  healthUnit   HealthUnit @relation(fields: [healthUnitId], references: [id])

  // Crianças
  childrenUnder1  Int @default(0)
  childrenUnder5  Int @default(0)
  activeFollowUps Int @default(0)

  // Acompanhamento
  healthConsultations    Int @default(0)
  growthAssessments      Int @default(0)
  developmentAssessments Int @default(0)

  // Imunização
  vaccinationCoverage Float @default(0)
  completeCalendar    Int   @default(0)
  incompleteCalendar  Int   @default(0)

  // Nutrição
  breastfeedingRate  Float @default(0)
  malnourished       Int   @default(0)
  severeMalnourished Int   @default(0)

  // Triagem
  neonatalTriaging      Int @default(0)
  developmentDeviations Int @default(0)

  // Desfecho
  preventableDeaths Int @default(0)
  accidents         Int @default(0)

  // Auditoria
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([healthUnitId, month, year])
  @@index([healthUnitId])
  @@index([month, year])
  @@map("pediatric_health_reports")
}

// Relatório de Vigilância Epidemiológica (SIAB-VE)
model EpidemiologyReport {
  id String @id @default(cuid())

  // Período
  week  Int
  month Int
  year  Int

  // Unidade
  healthUnitId String
  healthUnit   HealthUnit @relation(fields: [healthUnitId], references: [id])

  // Doença notificável
  diseaseCode String // Código SINAN
  diseaseName String

  // Casos
  suspectedCases Int @default(0)
  probableCases  Int @default(0)
  confirmedCases Int @default(0)

  // Desfecho
  recovered Int @default(0)
  deaths    Int @default(0)
  abandoned Int @default(0)

  // Status de notificação
  notified   Boolean   @default(false)
  notifiedAt DateTime?

  // Auditoria
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([healthUnitId, month, year, diseaseCode])
  @@index([healthUnitId])
  @@index([week, year])
  @@index([diseaseCode])
  @@index([notified])
  @@map("epidemiology_reports")
}

// ============================================
// END SUS/SIAB PRODUCTION REPORTS
// ============================================

// ============================================
// VACCINATION CALENDAR (Calendário Vacinal)
// ============================================

model Vaccine {
  id String @id @default(cuid())

  // Identificação
  name         String // Nome da vacina
  code         String? @unique // Código PNI
  manufacturer String?

  // Doenças cobertas
  diseasesCovered String[] // Array de doenças (Poliomielite, Sarampo, etc.)

  // Administração
  dosesRequired      Int // Número de doses necessárias
  intervalDays       Int? // Intervalo em dias entre doses
  boosterRequired    Boolean @default(false)
  boosterAfterMonths Int? // Reforço após X meses

  // Faixas etárias recomendadas
  ageGroups    String[] // ["0-2m", "2-4m", "6m", "12m", "15m", etc.]
  minAgeMonths Int? // Idade mínima em meses
  maxAgeMonths Int? // Idade máxima em meses (null = sem limite)

  // Informações adicionais
  description       String?
  contraindications String?
  sideEffects       String?

  // Status
  active      Boolean @default(true)
  pniIncluded Boolean @default(true) // Se está no PNI

  // Relacionamentos
  vaccinations    Vaccination[]
  scheduleEntries VaccineScheduleEntry[]

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([active])
  @@index([pniIncluded])
  @@map("vaccines")
}

model Vaccination {
  id String @id @default(cuid())

  // Relacionamentos principais
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  vaccineId String
  vaccine   Vaccine @relation(fields: [vaccineId], references: [id])

  // Dados da aplicação
  applicationDate DateTime @default(now())
  doseNumber      Int // Qual dose (1ª, 2ª, 3ª, reforço)

  // Lote e validade
  lot        String?
  expiryDate DateTime?

  // Local de aplicação
  healthUnitId String?
  healthUnit   HealthUnit? @relation("VaccinationHealthUnit", fields: [healthUnitId], references: [id])

  // Profissional que aplicou
  professionalId String?
  professional   User?   @relation("VaccinationProfessional", fields: [professionalId], references: [id])

  // Reação adversa
  adverseReaction Boolean @default(false)
  reactionDetails String?

  // Status
  status String @default("APPLIED") // APPLIED, SCHEDULED, MISSED, CONTRAINDICATED

  // Observações
  notes String?

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([vaccineId])
  @@index([applicationDate])
  @@index([healthUnitId])
  @@index([status])
  @@map("vaccinations")
}

model VaccineScheduleEntry {
  id String @id @default(cuid())

  // Vacina
  vaccineId String
  vaccine   Vaccine @relation(fields: [vaccineId], references: [id], onDelete: Cascade)

  // Idade recomendada
  ageMonths Int // Idade em meses (0, 2, 4, 6, 12, 15, etc.)
  ageLabel  String // Label legível ("Ao nascer", "2 meses", etc.)

  // Dose
  doseNumber Int
  doseType   String // INITIAL, BOOSTER, REINFORCEMENT

  // Detalhes
  description String?
  isOptional  Boolean @default(false)
  priority    Int     @default(1) // 1=alta, 2=média, 3=baixa

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([vaccineId, ageMonths, doseNumber])
  @@index([vaccineId])
  @@index([ageMonths])
  @@map("vaccine_schedule_entries")
}

// ============================================
// END VACCINATION CALENDAR
// ============================================

// ============================================
// PRENATAL CONSULTATION (Consulta Pré-Natal)
// ============================================

model PreNatalConsultation {
  id String @id @default(cuid())

  // Relacionamentos
  consultationId String       @unique
  consultation   Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)

  pregnancyId String?
  pregnancy   Pregnancy? @relation(fields: [pregnancyId], references: [id])

  // Trimestre
  trimester      Int // 1, 2, 3
  gestationalAge Int? // Idade gestacional em semanas

  // Medidas obstétricas
  uterineHeight  Int? // Altura uterina em cm
  fetalHeartRate Int? // Batimento cardíaco fetal (bpm)
  fetalMovements Boolean? // Movimentos fetais presentes

  // Testes laboratoriais
  syphilisTest      Boolean @default(false)
  vdrlTest          Boolean @default(false)
  urineTest         Boolean @default(false)
  glucoseTest       Boolean @default(false)
  hemoglobinTest    Boolean @default(false)
  hematocritTest    Boolean @default(false)
  hivTest           Boolean @default(false)
  hepatitisBTest    Boolean @default(false)
  toxoplasmosisTest Boolean @default(false)

  // Resultados dos testes (opcional)
  testResults Json?

  // Vacinação
  tetanusDose1     Boolean @default(false)
  tetanusDose2     Boolean @default(false)
  tetanusBooster   Boolean @default(false)
  tetanusImmune    Boolean @default(false)
  influenzaVaccine Boolean @default(false)

  // Classificação de risco
  riskLevel   String? // LOW_RISK, HIGH_RISK
  riskFactors String[] @default([])

  // Complicações
  gestationalDiabetes Boolean @default(false)
  preeclampsia        Boolean @default(false)
  hemorrhage          Boolean @default(false)
  prematureLabor      Boolean @default(false)

  // Orientações
  nutritionalGuidance Boolean @default(false)
  physicalActivity    Boolean @default(false)
  breastfeedingPrep   Boolean @default(false)

  // Próxima consulta
  nextConsultDate DateTime?

  // Observações
  notes String?

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pregnancyId])
  @@index([consultationId])
  @@index([trimester])
  @@index([riskLevel])
  @@map("prenatal_consultations")
}

model Pregnancy {
  id String @id @default(cuid())

  // Paciente
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Dados da gestação
  estimatedDueDate    DateTime // Data provável do parto
  lastMenstrualPeriod DateTime? // DUM
  gestationalAge      Int? // Idade gestacional em semanas

  // Status
  status String @default("ACTIVE") // ACTIVE, COMPLETED, INTERRUPTED

  // Histórico obstétrico
  gravidity Int? // Número de gestações (incluindo atual)
  parity    Int? // Número de partos
  abortions Int? // Número de abortos
  cesareans Int? // Número de cesáreas

  // Desfecho
  deliveryDate     DateTime?
  deliveryType     String? // VAGINAL, CESAREAN, FORCEPS
  deliveryLocation String? // HOSPITAL, HOME, OTHER

  // Recém-nascido
  birthWeight    Float? // Peso ao nascer (gramas)
  birthLength    Float? // Comprimento (cm)
  apgarScore1min Int? // Apgar 1 minuto
  apgarScore5min Int? // Apgar 5 minutos

  outcome String? // LIVE_BIRTH, STILLBIRTH

  // Puerpério
  postpartumVisit Boolean @default(false)
  complications   String?

  // Relacionamentos
  prenatalConsultations PreNatalConsultation[]

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([status])
  @@index([estimatedDueDate])
  @@map("pregnancies")
}

// ============================================
// END PRENATAL CONSULTATION
// ============================================

// ============================================
// ANTHROPOMETRIC MEASUREMENTS (Medidas Antropométricas)
// ============================================

// Expandir VitalSigns para incluir antropometria
// (será feito via alteração do modelo existente)

// ============================================
// GYNECOLOGICAL HISTORY (História Ginecológica)
// ============================================

model GynecologicalHistory {
  id String @id @default(cuid())

  // Paciente
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Consulta relacionada (opcional)
  consultationId String?
  consultation   Consultation? @relation(fields: [consultationId], references: [id])

  // Data do evento
  eventDate DateTime

  // Tipo de evento
  eventType String // MENARCHE, SEXARCHE, CONTRACEPTION, MENOPAUSE, PREGNANCY, ABORTION

  // Idade no evento
  ageAtEvent Int?

  // Detalhes específicos
  contraceptionMethod    String? // Para CONTRACEPTION
  contraceptionStartDate DateTime?
  contraceptionEndDate   DateTime?

  // Descrição
  description String?

  // Observações médicas
  clinicalNotes String?

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([consultationId])
  @@index([eventType])
  @@index([eventDate])
  @@map("gynecological_history")
}
