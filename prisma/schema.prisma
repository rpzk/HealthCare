// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  password   String? // Campo de senha com hash bcrypt (opcional para compatibilidade)
  name       String
  role       Role     @default(DOCTOR)
  speciality String?
  crmNumber  String?  @unique
  phone      String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relacionamentos
  patients       Patient[]
  consultations  Consultation[]
  prescriptions  Prescription[]
  examRequests   ExamRequest[]
  medicalRecords MedicalRecord[]
  referrals      Referral[]
  aiInteractions AIInteraction[]
  // Ocupa√ß√µes / Capability
  evaluationsAsSubject  CapabilityEvaluation[]
  evaluationsAsEvaluator CapabilityEvaluation[] @relation("EvaluatorUser")
  jobRoles UserJobRole[]
  notifications Notification[]
  doctorSchedules DoctorSchedule[]
  scheduleExceptions ScheduleException[]

  @@map("users")
}

model SystemModule {
  id          String   @id @default(cuid())
  key         String   @unique // ex: "psf", "integrative", "bi_analytics"
  name        String
  description String?
  isEnabled   Boolean  @default(false)
  features    Json?    // Lista de features espec√≠ficas ativas dentro do m√≥dulo
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_modules")
}

model Patient {
  id                 String    @id @default(cuid())
  name               String
  email              String    @unique
  phone              String?
  cpf                String?   // armazenada criptografada
  cpfHash            String?   @unique // hash para busca/indexa√ß√£o sem expor valor
  birthDate          DateTime
  gender             Gender
  emergencyContact   String?
  address            String?
  medicalHistory     String?   @db.Text
  allergies          String?   @db.Text
  currentMedications String?   @db.Text
  riskLevel          RiskLevel @default(BAIXO)
  insuranceNumber    String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relacionamentos
  consultations  Consultation[]
  prescriptions  Prescription[]
  vitalSigns     VitalSigns[]
  attachments    Attachment[]
  documents      MedicalDocument[]
  examResults    ExamResult[]
  medicalRecords MedicalRecord[]
  addresses      Address[]
  diagnoses      Diagnosis[]
  User           User?             @relation(fields: [userId], references: [id])
  userId         String?
  ExamRequest    ExamRequest[]
  referrals      Referral[]
  financialTransactions FinancialTransaction[]
  
  // PSF / Sa√∫de da Fam√≠lia
  household      Household? @relation(fields: [householdId], references: [id])
  householdId    String?
  isHeadOfHousehold Boolean @default(false)

  @@map("patients")
}

model Household {
  id          String   @id @default(cuid())
  name        String   // ex: "Fam√≠lia Silva"
  address     String
  number      String?
  complement  String?
  neighborhood String?
  city        String?
  state       String?
  zipCode     String?
  
  // PSF Info
  microArea   String?
  familyType  String?  // Nuclear, Estendida, Unipessoal
  
  members     Patient[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("households")
}

model Referral {
  id          String   @id @default(cuid())
  patientId   String
  doctorId    String
  specialty   String
  description String
  priority    String   @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  status      String   @default("PENDING") // PENDING, SCHEDULED, COMPLETED, CANCELLED
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  patient Patient @relation(fields: [patientId], references: [id])
  doctor  User    @relation(fields: [doctorId], references: [id])

  @@map("referrals")
}

model MedicalRecord {
  id             String     @id @default(cuid())
  title          String
  description    String
  diagnosis      String?
  treatment      String?
  notes          String?
  recordType     RecordType
  severity       Severity   @default(LOW)
  priority       String     @default("NORMAL") // LOW, NORMAL, HIGH, CRITICAL
  isPrivate      Boolean    @default(false)
  sourceDocument String? // Para vincular a documentos importados
  
  // Phase 2: Security & Audit
  version        Int        @default(1) // Optimistic locking for concurrent updates
  deletedAt      DateTime?  // Soft-delete timestamp (LGPD: allows record restoration)
  
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relacionamentos
  patient     Patient      @relation(fields: [patientId], references: [id])
  patientId   String
  doctor      User         @relation(fields: [doctorId], references: [id])
  doctorId    String
  attachments Attachment[]
  aiAnalysis  AIAnalysis[]

  // Indexes for performance and audit
  @@index([patientId])
  @@index([doctorId])
  @@index([recordType])
  @@index([createdAt])
  @@index([deletedAt]) // For soft-delete queries
  @@map("medical_records")
}

model Consultation {
  id             String             @id @default(cuid())
  scheduledDate  DateTime
  actualDate     DateTime?
  duration       Int? // em minutos
  type           ConsultationType
  status         ConsultationStatus @default(SCHEDULED)
  chiefComplaint String?
  history        String?
  physicalExam   String?
  assessment     String?
  plan           String?
  notes          String?
  videoUrl       String?            // URL da grava√ß√£o da teleconsulta
  meetingLink    String?            // Link para a sala de teleconsulta
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  // Relacionamentos
  patient       Patient        @relation(fields: [patientId], references: [id])
  patientId     String
  doctor        User           @relation(fields: [doctorId], references: [id])
  doctorId      String
  prescriptions Prescription[]
  examRequests  ExamRequest[]
  vitalSigns    VitalSigns[]
  diagnoses     Diagnosis[]
  financialTransaction FinancialTransaction?

  @@map("consultations")
}

model Prescription {
  id           String             @id @default(cuid())
  medication   String
  dosage       String
  frequency    String
  duration     String
  instructions String?
  status       PrescriptionStatus @default(ACTIVE)
  startDate    DateTime           @default(now())
  endDate      DateTime?
  digitalSignature String?        // Assinatura digital (hash ou token)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  // Relacionamentos
  patient        Patient       @relation(fields: [patientId], references: [id])
  patientId      String
  doctor         User          @relation(fields: [doctorId], references: [id])
  doctorId       String
  consultation   Consultation? @relation(fields: [consultationId], references: [id])
  consultationId String?

  @@map("prescriptions")
}

model ExamRequest {
  id            String     @id @default(cuid())
  examType      String
  description   String?
  urgency       Urgency    @default(ROUTINE)
  status        ExamStatus @default(REQUESTED)
  requestDate   DateTime   @default(now())
  scheduledDate DateTime?
  completedDate DateTime?
  results       String?
  notes         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relacionamentos
  patient        Patient       @relation(fields: [patientId], references: [id])
  patientId      String
  doctor         User          @relation(fields: [doctorId], references: [id])
  doctorId       String
  consultation   Consultation? @relation(fields: [consultationId], references: [id])
  consultationId String?
  attachments    Attachment[]

  @@map("exam_requests")
}

model VitalSigns {
  id               String   @id @default(cuid())
  systolicBP       Int? // Press√£o arterial sist√≥lica
  diastolicBP      Int? // Press√£o arterial diast√≥lica
  heartRate        Int? // Frequ√™ncia card√≠aca
  respiratoryRate  Int? // Frequ√™ncia respirat√≥ria
  temperature      Float? // Temperatura corporal
  weight           Float? // Peso em kg
  height           Float? // Altura em cm
  bmi              Float? // IMC calculado
  oxygenSaturation Int? // Satura√ß√£o de oxig√™nio
  bloodGlucose     Int? // Glicemia
  notes            String?
  recordedAt       DateTime @default(now())
  createdAt        DateTime @default(now())

  // Relacionamentos
  patient        Patient       @relation(fields: [patientId], references: [id])
  patientId      String
  consultation   Consultation? @relation(fields: [consultationId], references: [id])
  consultationId String?

  @@map("vital_signs")
}

model Attachment {
  id           String   @id @default(cuid())
  fileName     String
  originalName String
  fileSize     Int
  mimeType     String
  filePath     String
  description  String?
  createdAt    DateTime @default(now())

  // Relacionamentos
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])
  medicalRecordId String?
  examRequest     ExamRequest?   @relation(fields: [examRequestId], references: [id])
  examRequestId   String?
  Patient         Patient?       @relation(fields: [patientId], references: [id])
  patientId       String?

  @@map("attachments")
}

// üìÑ Modelos para Importa√ß√£o Inteligente de Documentos M√©dicos

model MedicalDocument {
  id            String                @id @default(cuid())
  fileName      String
  content       String                @db.Text
  fileType      DocumentFileType
  status        DocumentProcessStatus @default(PENDING)
  uploadDate    DateTime              @default(now())
  errorMessage  String?
  importResults String?               @db.Text
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  // Relacionamentos
  patient   Patient?          @relation(fields: [patientId], references: [id])
  patientId String?
  analysis  DocumentAnalysis?

  @@map("medical_documents")
}

model DocumentAnalysis {
  id               String       @id @default(cuid())
  confidence       Float
  documentType     DocumentType
  patientInfo      String       @db.Text // JSON
  extractedData    String       @db.Text // JSON
  suggestedActions String       @db.Text // JSON
  analysisDate     DateTime     @default(now())
  reviewed         Boolean      @default(false)
  reviewedBy       String?
  reviewedAt       DateTime?

  // Relacionamentos
  document   MedicalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId String          @unique

  @@map("document_analysis")
}

model ExamResult {
  id             String   @id @default(cuid())
  examType       String
  results        String   @db.Text // JSON para m√∫ltiplos resultados
  examDate       DateTime
  sourceDocument String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relacionamentos
  patient   Patient @relation(fields: [patientId], references: [id])
  patientId String

  @@map("exam_results")
}

// Endere√ßos estruturados com georreferenciamento
model Address {
  id           String     @id @default(cuid())
  street       String
  number       String?
  complement   String?
  neighborhood String?
  city         String
  state        String
  zipCode      String?
  latitude     Float?
  longitude    Float?
  isPrimary    Boolean    @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relacionamentos
  patient     Patient?   @relation(fields: [patientId], references: [id])
  patientId   String?
  microArea   MicroArea? @relation(fields: [microAreaId], references: [id])
  microAreaId String?
  Place       Place[]

  @@index([patientId])
  @@index([microAreaId])
  @@index([latitude, longitude])
  @@map("addresses")
}

// Locais de interesse (unidades, eventos, etc.) com georreferenciamento
model Place {
  id          String     @id @default(cuid())
  name        String
  description String?
  category    String?
  latitude    Float?
  longitude   Float?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relacionamentos
  address   Address?   @relation(fields: [addressId], references: [id])
  addressId String?
  microArea MicroArea? @relation(fields: [microAreaId], references: [id])
  microAreaId String?

  @@map("places")
  @@index([microAreaId])
  @@index([latitude, longitude])
}

// Micro√°reas/√°reas adstritas para planejamento epidemiol√≥gico
model MicroArea {
  id           String   @id @default(cuid())
  name         String
  code         String?  @unique
  description  String?
  polygonGeo   String?  @db.Text // GeoJSON da √°rea (opcional)
  centroidLat  Float?
  centroidLng  Float?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  // Bounding box derivado para pr√©-filtro espacial
  minLat       Float?
  minLng       Float?
  maxLat       Float?
  maxLng       Float?

  // Relacionamentos
  addresses Address[]
  places    Place[]
  revisions MicroAreaRevision[]
  @@index([centroidLat, centroidLng])
  @@index([minLat, maxLat])
  @@index([minLng, maxLng])

  @@map("micro_areas")
}

model MicroAreaRevision {
  id            String    @id @default(cuid())
  microArea     MicroArea @relation(fields: [microAreaId], references: [id])
  microAreaId   String
  previousGeo   String?   @db.Text
  newGeo        String?   @db.Text
  changedByUser String?
  reason        String?
  createdAt     DateTime  @default(now())

  @@index([microAreaId, createdAt])
  @@map("micro_area_revisions")
}

// ---------------------- SISTEMA DE CODIFICA√á√ÉO CL√çNICA ----------------------

model CodeSystem {
  id          String          @id @default(cuid())
  kind        CodeSystemKind
  name        String
  version     String?
  description String?
  active      Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  codes       MedicalCode[]

  @@unique([kind, version])
  @@map("code_systems")
}

model MedicalCode {
  id             String        @id @default(cuid())
  system         CodeSystem    @relation(fields: [systemId], references: [id])
  systemId       String
  code           String
  display        String
  description    String?       @db.Text
  parentId       String?
  parent         MedicalCode?  @relation("MedicalCodeHierarchy", fields: [parentId], references: [id])
  children       MedicalCode[] @relation("MedicalCodeHierarchy")
  synonyms       String?       @db.Text // JSON string array para sin√¥nimos
  searchableText String?       @db.Text
  active         Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  primaryIn      Diagnosis[]   @relation("PrimaryCode")
  secondaryIn    DiagnosisSecondaryCode[]

  @@unique([systemId, code])
  @@index([code])
  @@index([display])
  @@map("medical_codes")
}

model Diagnosis {
  id              String                  @id @default(cuid())
  patient         Patient                 @relation(fields: [patientId], references: [id])
  patientId       String
  consultation    Consultation?           @relation(fields: [consultationId], references: [id])
  consultationId  String?
  primaryCode     MedicalCode             @relation("PrimaryCode", fields: [primaryCodeId], references: [id])
  primaryCodeId   String
  secondaryCodes  DiagnosisSecondaryCode[]
  status          DiagnosisStatus         @default(ACTIVE)
  certainty       DiagnosisCertainty      @default(CONFIRMED)
  notes           String?                 @db.Text
  onsetDate       DateTime?
  resolvedDate    DateTime?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  revisions       DiagnosisRevision[]

  @@index([patientId])
  @@index([consultationId])
  @@map("diagnoses")
}

model DiagnosisSecondaryCode {
  id           String      @id @default(cuid())
  diagnosis    Diagnosis   @relation(fields: [diagnosisId], references: [id], onDelete: Cascade)
  diagnosisId  String
  code         MedicalCode @relation(fields: [codeId], references: [id])
  codeId       String
  order        Int         @default(0)
  createdAt    DateTime    @default(now())

  @@unique([diagnosisId, codeId])
  @@index([codeId])
  @@map("diagnosis_secondary_codes")
}

// Hist√≥rico de revis√µes de diagn√≥sticos (auditoria de mudan√ßas)
model DiagnosisRevision {
  id             String     @id @default(cuid())
  diagnosis      Diagnosis  @relation(fields: [diagnosisId], references: [id])
  diagnosisId    String
  previous       Json?
  next           Json?
  changedAt      DateTime   @default(now())
  changedByUserId String?
  reason         String?

  @@index([diagnosisId, changedAt])
  @@map("diagnosis_revisions")
}

enum DocumentFileType {
  DOCX
  DOC
  PDF
  TXT
  RTF
}

enum DocumentProcessStatus {
  PENDING
  ANALYZING
  CLASSIFIED
  IMPORTED
  ERROR
}

enum DocumentType {
  EVOLUCAO
  EXAME
  PRESCRICAO
  ANAMNESE
  ATESTADO
  RECEITA
  LAUDO
  OUTROS
}

model AIInteraction {
  id         String        @id @default(cuid())
  type       AIRequestType
  prompt     String
  response   String
  confidence Float?
  metadata   Json?
  createdAt  DateTime      @default(now())

  // Relacionamentos
  user   User   @relation(fields: [userId], references: [id])
  userId String

  @@map("ai_interactions")
}

model AIAnalysis {
  id           String   @id @default(cuid())
  analysisType String
  input        String
  result       String
  confidence   Float
  suggestions  String[]
  metadata     Json?
  createdAt    DateTime @default(now())

  // Relacionamentos
  medicalRecord   MedicalRecord @relation(fields: [medicalRecordId], references: [id])
  medicalRecordId String

  @@map("ai_analysis")
}

// Uso agregado di√°rio de quotas de IA para evitar COUNT caro em tempo real
model AIQuotaUsage {
  id        String   @id @default(cuid())
  userId    String
  type      String
  date      DateTime
  count     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, type, date])
  @@index([type, date])
  @@map("ai_quota_usage")
}

// Logs de auditoria persistentes
model AuditLog {
  id            String   @id @default(cuid())
  
  // Core tracking
  action        String   // CREATE, READ, UPDATE, DELETE, ERROR
  resourceType  String   @default("MEDICAL_RECORD")
  resourceId    String
  
  // User attribution
  userId        String
  userEmail     String
  userRole      String
  
  // Operation details
  success       Boolean   @default(true)
  errorMessage  String?   @db.Text
  
  // Change tracking (Phase 2: before/after snapshots)
  changes       Json?    // Array of { field, before, after } objects
  metadata      Json?    // { ipAddress, userAgent, reason, ... }
  
  // Request context
  ipAddress     String?
  userAgent     String?
  
  createdAt     DateTime  @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([resourceId, createdAt])
  @@index([resourceType, createdAt])
  @@index([success, createdAt]) // For error tracking
  @@map("audit_logs")
}

// Phase 2: Rate Limiting tracking for distributed systems (Phase 3 Redis migration)
model RateLimitLog {
  id        String   @id @default(cuid())
  userId    String
  operation String   // CREATE, READ, UPDATE, DELETE
  timestamp DateTime @default(now())
  
  // Expires after 1 day for daily limits, 1 hour for hourly, 1 minute for per-minute
  expiresAt DateTime? // Used for automatic cleanup
  
  @@index([userId, operation, timestamp])
  @@index([expiresAt]) // For cleanup queries
  @@map("rate_limit_logs")
}

// Enums
enum Role {
  ADMIN
  DOCTOR
  NURSE
  RECEPTIONIST
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum RiskLevel {
  BAIXO
  MEDIO
  ALTO
  CRITICO
}

enum BloodType {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum RecordType {
  CONSULTATION
  EXAM
  PRESCRIPTION
  DIAGNOSIS
  TREATMENT
  SURGERY
  EMERGENCY
  FOLLOW_UP
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ConsultationType {
  INITIAL
  FOLLOW_UP
  EMERGENCY
  ROUTINE
  SPECIALIST
}

enum ConsultationStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PrescriptionStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  EXPIRED
}

enum ExamStatus {
  REQUESTED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Urgency {
  ROUTINE
  URGENT
  EMERGENCY
}

enum AIRequestType {
  DIAGNOSIS_SUGGESTION
  TREATMENT_RECOMMENDATION
  DRUG_INTERACTION_CHECK
  SYMPTOM_ANALYSIS
  MEDICAL_SUMMARY
  RISK_ASSESSMENT
}

// Enum para distinguir sistemas de codifica√ß√£o suportados
enum CodeSystemKind {
  CID10
  CID11
  CIAP2
  NURSING
}

enum DiagnosisStatus {
  ACTIVE
  RESOLVED
  ENTERED_IN_ERROR
  INACTIVE
}

enum DiagnosisCertainty {
  SUSPECTED
  PROBABLE
  CONFIRMED
  RULED_OUT
}

// Log de atualiza√ß√µes externas (CID/ICD/CIAP/CBO)
enum ExternalSourceType {
  ICD10
  ICD11
  CIAP2
  NURSING
  CBO
}

model ExternalSourceUpdate {
  id            String            @id @default(cuid())
  sourceType    ExternalSourceType
  versionTag    String?
  status        String            // RUNNING | SUCCESS | ERROR
  startedAt     DateTime          @default(now())
  finishedAt    DateTime?
  fetchedCount  Int               @default(0)
  insertedCount Int               @default(0)
  updatedCount  Int               @default(0)
  skippedCount  Int               @default(0)
  retiredCount  Int               @default(0)
  checksum      String?           // hash do arquivo bruto
  errorMessage  String?           @db.Text
  meta          String?           @db.Text // JSON extra

  @@index([sourceType, startedAt])
  @@map("external_source_updates")
}

// --------- Elliott Jaques / CBO Occupation & Capability System ---------

enum StratumLevel {
  S1
  S2
  S3
  S4
  S5
  S6
  S7
  S8
}

// Grupos hier√°rquicos do CBO (grande grupo, subgrupo, fam√≠lia etc.)
model CBOGroup {
  id        String     @id @default(cuid())
  code      String     @unique
  name      String
  level     Int        // 1=Grande Grupo, 2=Subgrupo Principal, 3=Subgrupo, 4=Fam√≠lia
  parentId  String?
  parent    CBOGroup?  @relation("CBOGroupHierarchy", fields: [parentId], references: [id])
  children  CBOGroup[] @relation("CBOGroupHierarchy")
  occupations Occupation[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([level])
  @@map("cbo_groups")
}

model Occupation {
  id          String    @id @default(cuid())
  code        String    @unique
  title       String
  description String?   @db.Text
  groupId     String?
  group       CBOGroup? @relation(fields: [groupId], references: [id])
  synonyms    String?   @db.Text // JSON array
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  roles       JobRole[]

  @@index([groupId])
  @@map("occupations")
}

// Papel / Cargo espec√≠fico associado a uma ocupa√ß√£o (pode refinar requisitos)
model JobRole {
  id                 String      @id @default(cuid())
  title              String
  occupationId       String?
  occupation         Occupation? @relation(fields: [occupationId], references: [id])
  requiredMinStratum StratumLevel
  requiredMaxStratum StratumLevel?
  description        String?     @db.Text
  tasks              String?     @db.Text // lista ou markdown
  capabilitiesJson   String?     @db.Text // JSON com pesos por dimens√£o
  active             Boolean     @default(true)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  evaluations        CapabilityEvaluation[]
  userAssignments    UserJobRole[]

  @@index([occupationId])
  @@map("job_roles")
}

// Atribui√ß√£o de usu√°rio a um papel/cargo
model UserJobRole {
  id        String   @id @default(cuid())
  userId    String
  jobRoleId String
  assignedAt DateTime @default(now())
  active    Boolean  @default(true)

  user    User    @relation(fields: [userId], references: [id])
  jobRole JobRole @relation(fields: [jobRoleId], references: [id])

  @@unique([userId, jobRoleId])
  @@index([jobRoleId])
  @@map("user_job_roles")
}

// Avalia√ß√£o de capacidade segundo Estratos de Elliott Jaques
model CapabilityEvaluation {
  id              String       @id @default(cuid())
  subjectUserId   String
  subjectUser     User         @relation(fields: [subjectUserId], references: [id])
  evaluatorUserId String
  evaluatorUser   User         @relation("EvaluatorUser", fields: [evaluatorUserId], references: [id])
  jobRoleId       String?
  jobRole         JobRole?     @relation(fields: [jobRoleId], references: [id])
  stratumAssessed StratumLevel
  potentialStratum StratumLevel?
  timeSpanMonths  Int?         // Estimativa de alcance temporal de decis√£o
  evidence        String?      @db.Text // Observa√ß√µes qualitativas
  gaps            String?      @db.Text // JSON com lacunas por dimens√£o
  recommendations String?      @db.Text // A√ß√µes sugeridas
  capabilityScores String?     @db.Text // JSON com pontua√ß√£o calculada por dimens√£o
  createdAt       DateTime     @default(now())

  @@index([subjectUserId, createdAt])
  @@index([evaluatorUserId, createdAt])
  @@index([jobRoleId])
  @@map("capability_evaluations")
}

// --- FINANCEIRO ---

model FinancialTransaction {
  id          String   @id @default(cuid())
  type        TransactionType // INCOME, EXPENSE
  amount      Decimal  @db.Decimal(10, 2)
  description String
  category    String   // Ex: "Consulta", "Aluguel", "Equipamento"
  status      TransactionStatus @default(PENDING)
  dueDate     DateTime
  paidDate    DateTime?
  paymentMethod String? // PIX, CREDIT_CARD, CASH, BOLETO

  // Relacionamentos
  patient     Patient? @relation(fields: [patientId], references: [id])
  patientId   String?
  consultation Consultation? @relation(fields: [consultationId], references: [id])
  consultationId String? @unique
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("financial_transactions")
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionStatus {
  PENDING
  PAID
  CANCELLED
  OVERDUE
}

// --- AGENDA AVAN√áADA ---

model DoctorSchedule {
  id        String   @id @default(cuid())
  doctor    User     @relation(fields: [doctorId], references: [id])
  doctorId  String
  dayOfWeek Int      // 0=Sunday, 1=Monday, ...
  startTime String   // "08:00"
  endTime   String   // "18:00"
  slotDuration Int   @default(30) // minutos
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([doctorId, dayOfWeek])
  @@map("doctor_schedules")
}

model ScheduleException {
  id        String   @id @default(cuid())
  doctor    User     @relation(fields: [doctorId], references: [id])
  doctorId  String
  date      DateTime
  isAvailable Boolean @default(false) // Se false, √© bloqueio. Se true, √© exce√ß√£o de disponibilidade extra.
  reason    String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("schedule_exceptions")
}

// --- NOTIFICA√á√ïES (Persist√™ncia) ---

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String   // 'appointment_reminder', 'system', etc.
  priority  String   @default("low") // low, medium, high, critical
  title     String
  message   String
  read      Boolean  @default(false)
  metadata  Json?
  expiresAt DateTime?
  
  createdAt DateTime @default(now())

  @@index([userId, read])
  @@map("notifications")
}

model CIAP2 {
  code        String   @id
  description String
  chapter     String   // A, B, D...
  gender      String?  // M, F, A (Ambos)
  active      Boolean  @default(true)

  @@map("ciap2")
}
