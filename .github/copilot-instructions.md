# Copilot Instructions

- INSTRUÇÃO MANDATÓRIA: é proibido usar dados simulados/mocados/de exemplo; só utilize dados reais já existentes e nunca invente valores.
- Stack: Next.js 14 app router with TypeScript, Prisma/PostgreSQL, NextAuth (JWT sessions), Tailwind/Radix UI, Redis+BullMQ for AI jobs, optional Ollama for local LLM; see docker services in [docker-compose.yml](docker-compose.yml).
- Domain map: app routes live under [app/](app) (admin/bi, prescriptions/, certificates/, tele/, questionnaires/ etc.). Key recent features: NPS ([app/api/nps/route.ts](app/api/nps/route.ts)), BI dashboard ([app/api/bi/dashboard/route.ts](app/api/bi/dashboard/route.ts)), medication tracking ([app/api/medications/tracking/route.ts](app/api/medications/tracking/route.ts)), medical certificates ([app/api/certificates/](app/api/certificates)), digital signatures schema in [prisma/schema.prisma](prisma/schema.prisma), backups via [scripts/healthcare-backup.sh](scripts/healthcare-backup.sh) and [backup-db.sh](backup-db.sh).
- Auth/RBAC: NextAuth config in [lib/auth.ts](lib/auth.ts) with credentials + passkey providers; JWT stores `id` and `role`, with optional `availableRoles` from `UserAssignedRole`. Use `auth()` from [auth.ts](auth.ts) or `getServerSession(authOptions)` in APIs and enforce patient/role checks (see medication tracking POST/GET for pattern).
- Data access: Prefer the Prisma singleton in [lib/prisma.ts](lib/prisma.ts); avoid spawning new Prisma clients unless you mirror NPS service behavior. Keep selects narrow and include relations explicitly. Prisma schema is large; new models belong in [prisma/schema.prisma](prisma/schema.prisma) and require `npm run db:migrate` or `npm run db:push` + `npm run db:generate`.
- API handlers: Route handlers follow zod validation + auth guard + resource ownership checks and return `NextResponse.json` with explicit status (see [app/api/medications/tracking/route.ts](app/api/medications/tracking/route.ts#L1-L210) and [app/api/nps/route.ts](app/api/nps/route.ts#L1-L120)). Keep runtime `nodejs` when using Prisma. Handle 401/403/404/500 separately.
- Middleware/security: [middleware.ts](middleware.ts) adds IP rate limiting (300/min), security headers, CSP allowing Ollama connect-src, and HSTS in production. Avoid bypassing it; for streaming or new external calls update CSP/connect-src accordingly.
- UI patterns: Components live in [components/](components) and use React Hook Form + zod, shadcn/Radix primitives, and Tailwind via [app/globals.css](app/globals.css). Prefer colocated feature folders (nps, bi, prescriptions, certificates) and reuse shared UI under [components/ui/](components/ui).
- AI pipeline: BullMQ queue defined in [lib/ai-bullmq-queue.ts](lib/ai-bullmq-queue.ts) (Redis host/port env). Worker entry is `npm run worker:ai`. Jobs: `symptom_analysis`, `transcribe_and_generate_soap_draft`, `transcribe_and_generate_soap` (transcription via `transcribeFile`, SOAP creation, optional persistence). Cancelation flag stored in Redis key `ai-job:cancel:<id>`.
- External adapters: Coding/catalog ingest adapters follow `ExternalFetchAdapter` interface (name, sourceType, fetchList, mapRecord, optional version) in [lib/adapters/README.md](lib/adapters/README.md); place downloaded CBO files in `uploads/external-cache` and configure `CBO_LOCAL_PATH` or `CBO_XLSX_URL`.
- Telemedicine diagnostics: Quick smoke tests for WebRTC/tele features in [scripts/test-telemedicine.sh](scripts/test-telemedicine.sh) and [scripts/test-api-endpoints.js](scripts/test-api-endpoints.js); interactive page at `/test-telemedicine.html` when `npm run dev` is running (see lower section of [docs/TESTING_GUIDE.md](docs/TESTING_GUIDE.md)).
- Backups/ops: Daily backup scripts are in [backup-db.sh](backup-db.sh) and [scripts/healthcare-backup.sh](scripts/healthcare-backup.sh); cron is expected at 2 AM. ENV placeholders live in [.env.example](.env.example) (NextAuth, DATABASE_URL, OLLAMA_URL/MODEL, REDIS_HOST, SMTP settings, OTEL_*). Observability is off by default; to enable OpenTelemetry rename [instrumentation.ts.disabled](instrumentation.ts.disabled) to `instrumentation.ts` and set `OTEL_ENABLED=true`.
- Runbook: Local dev `npm run dev` (or task "Docker up dev" to boot postgres/redis); type safety `npm run type-check`; lint `npm run lint`; Prisma `npm run db:migrate` / `npm run db:push` / `npm run db:generate`; production build `npm run build && npm run start`; prod Docker `docker compose -f docker-compose.prod.yml up -d --build`.
- Documentation hotspots: Feature summaries and test commands live in [docs/QUICK_REFERENCE.md](docs/QUICK_REFERENCE.md), [docs/COMPLETION_SUMMARY.md](docs/COMPLETION_SUMMARY.md), and [docs/TESTING_GUIDE.md](docs/TESTING_GUIDE.md); check these before modifying feature areas.
- Contribution tips: Respect RBAC checks for patient data, return localized error messages when existing endpoints do, and prefer the established audit logging style in services like [lib/nps-service.ts](lib/nps-service.ts). Align new endpoints with pagination/filter conventions from medication tracking and add zod schemas for input validation.
